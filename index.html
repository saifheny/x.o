<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SA Educational Institution</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        :root {
            --bg-deep: #000000;
            --bg-surface: #0a0a0a;
            --bg-card: #141414;
            --glass-bg: rgba(10, 10, 10, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-primary: #3b82f6; 
            --accent-gold: #ffd700; 
            --accent-glow: rgba(59, 130, 246, 0.4);
            --nav-height: 65px;
            --radius-xl: 24px;
            --font-main: 'Cairo', sans-serif;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --chat-bg: #0b0b0b;
            --chat-bubble-sent: #005c4b;
            --chat-bubble-recv: #202c33;
        }
        *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body {
            height: 100%;
            overscroll-behavior-y: none;
        }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            color: var(--text-main);
            margin: 0; padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.08), transparent 70%);
        }
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .w-full { width: 100%; }
        .modern-btn {
            background: #ffffff; color: #000000;
            font-family: var(--font-main); font-weight: 700;
            padding: 12px 30px; border-radius: 50px;
            border: none; font-size: 0.95rem;
            box-shadow: 0 5px 20px rgba(255,255,255,0.15);
            cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%;
        }
        @media (min-width: 768px) {
            .modern-btn { width: auto; min-width: 180px; max-width: 250px; margin: 0 auto; display: inline-flex; }
            .app-section { text-align: center; }
            .app-section .smart-input, .app-section .google-bar { max-width: 600px; margin-left: auto; margin-right: auto; }
            .card-wrapper, .mini-card, .create-exam-cta, .reese-card { max-width: 700px; margin-left: auto; margin-right: auto; text-align: right; }
            .nav-container { max-width: 800px; }
        }
        .modern-btn:active { transform: scale(0.97); }
        .modern-btn.secondary {
            background: rgba(255,255,255,0.08); color: #fff;
            border: 1px solid var(--glass-border); box-shadow: none;
        }
        .glossy-black-btn {
            background: linear-gradient(145deg, #1f1f1f, #000000);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
            font-family: var(--font-main); font-weight: 700;
            padding: 14px 30px; border-radius: 50px;
            cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; font-size: 1rem;
        }
        @media (min-width: 768px) { .glossy-black-btn { width: auto; min-width: 180px; max-width: 300px; margin: 0 auto; } }
        .glossy-black-btn:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.2);
            transform: translateY(-2px); border-color: rgba(255,255,255,0.25);
        }
        .glossy-black-btn.danger i { color: var(--danger); }
        .shiny-back-btn {
            position: absolute; top: 20px; right: 20px; z-index: 5002;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); color: #fff;
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
            transition: all 0.3s ease; overflow: hidden;
        }
        .shiny-back-btn::after {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            transform: rotate(45deg) translate(-100%, -100%);
            animation: shine 3s infinite;
        }
        @keyframes shine { 
            0% { transform: rotate(45deg) translate(-100%, -100%); }
            20% { transform: rotate(45deg) translate(100%, 100%); }
            100% { transform: rotate(45deg) translate(100%, 100%); }
        }
        .shiny-back-btn:active { transform: scale(0.9); }
        .icon-btn-small {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer; font-size: 0.9rem;
            color: #fff; background: rgba(255,255,255,0.1);
        }
        .icon-actions {
            display: flex; gap: 8px; justify-content: space-around;
            padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 5px;
        }
        .action-icon {
            background: transparent; border: none;
            color: var(--text-secondary); font-size: 1.1rem;
            cursor: pointer; transition: 0.2s;
            padding: 8px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            width: 40px; height: 40px;
        }
        .action-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .action-icon.edit:hover { color: var(--accent-primary); background: rgba(59, 130, 246, 0.15); }
        .action-icon.delete:hover { color: var(--danger); background: rgba(239, 68, 68, 0.15); }
        .action-icon.share:hover { color: var(--success); background: rgba(16, 185, 129, 0.15); }
        .action-icon.gold:hover { color: var(--accent-gold); background: rgba(255, 215, 0, 0.15); }
        .action-icon.view:hover { color: #d946ef; background: rgba(217, 70, 239, 0.15); }
        .action-icon.results-icon:hover { color: #06b6d4; background: rgba(6, 182, 212, 0.15); }
        .back-btn-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px; cursor: pointer;
            color: var(--text-secondary); transition: 0.3s;
            font-weight: bold; background: rgba(255,255,255,0.05);
            padding: 8px 16px; border-radius: 20px; width: fit-content;
        }
        .back-btn-header:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .top-nav {
            position: fixed; top: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            transition: top 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); 
        }
        .nav-hidden { top: -80px; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 20px; max-width: 800px; }
        .nav-btn {
            background: transparent; border: none; color: #666;
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; transition: 0.3s; position: relative;
        }
        .nav-btn i { font-size: 1.3rem; transition: 0.3s; }
        .nav-btn span { font-size: 0.65rem; font-weight: 600; opacity: 0.7; }
        .nav-btn.active { color: var(--text-main); }
        .nav-btn.active i { color: var(--accent-primary); transform: translateY(-3px); text-shadow: 0 0 15px var(--accent-glow); }
        .magic-btn.active i { color: #d946ef; text-shadow: 0 0 15px rgba(217, 70, 239, 0.6); }
        .portal-container {
            padding-top: calc(var(--nav-height) + 15px);
            padding-bottom: 100px;
            padding-left: 15px; padding-right: 15px;
            max-width: 1000px; margin: 0 auto;
            min-height: 100vh;
        }
        .mini-card {
            background: #141414;
            border: 1px solid rgba(255,255,255,0.05);
            border-bottom: 2px solid rgba(255,255,255,0.02);
            border-radius: 18px; padding: 18px; margin-bottom: 0;
            position: relative; transition: all 0.2s;
            display: flex; flex-direction: column; gap: 10px;
            text-align: right; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .mini-card:hover { border-color: rgba(255,255,255,0.12); transform: translateY(-2px); }
        .card-wrapper { margin-bottom: 20px; }
        .create-exam-cta {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; padding: 20px; margin-bottom: 25px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-height: 90px;
        }
        .create-exam-cta:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); }
        .create-exam-cta:active { transform: scale(0.98); }
        .cta-content { display: flex; align-items: center; gap: 15px; position: relative; z-index: 2; width: 100%; }
        .cta-icon-wrapper {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--accent-primary); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 0 15px var(--accent-glow); flex-shrink: 0;
        }
        .cta-bg-icon {
            position: absolute; left: -10px; bottom: -15px;
            font-size: 5rem; color: #fff; opacity: 0.03;
            transform: rotate(15deg); pointer-events: none;
        }
        .typewriter-text { font-family: 'Outfit', var(--font-main); font-weight: 700; font-size: 1.1rem; color: #fff; display: inline-block; }
        .typewriter-cursor {
            display: inline-block; width: 2px; height: 1.1rem;
            background-color: var(--accent-primary);
            margin-right: 2px; animation: blink 1s step-end infinite;
            vertical-align: middle;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .landing-avatar-img {
            width: 140px; height: auto; margin-bottom: 20px; display: block;
            filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.4));
            animation: breathe 3s ease-in-out infinite;
        }
        @keyframes breathe { 0% { transform: scale(0.95); opacity: 0.9; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.9; } }
        .landing-text {
            color: #ccc; letter-spacing: 1px; font-size: 1.1rem; margin-top: 10px; 
            max-width: 90%; line-height: 1.6; min-height: 50px;
            font-weight: 600; text-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-title { font-weight: 700; font-size: 1.05rem; color: #fff; margin: 0; line-height: 1.4; }
        .card-meta { font-size: 0.75rem; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        .teacher-badge {
            background: rgba(255, 215, 0, 0.15); color: var(--accent-gold);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold;
        }
        .smart-input {
            width: 100%; background: #151515;
            border: 1px solid var(--glass-border);
            padding: 14px 18px; border-radius: 14px;
            color: #fff; font-size: 0.95rem; margin-bottom: 10px;
            outline: none; transition: 0.3s; font-family: var(--font-main);
        }
        .smart-input:focus { border-color: var(--accent-primary); background: #0a0a0a; }
        .names-row { display: flex; gap: 10px; width: 100%; margin-bottom: 5px; }
        .names-row .smart-input { flex: 1; }
        .google-bar {
            width: 100%; background: #1c1c1c;
            border: 1px solid var(--glass-border);
            border-radius: 50px; padding: 12px 20px 12px 45px;
            color: #fff; font-family: var(--font-main);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .search-wrap { position: relative; margin-bottom: 20px; }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #666; font-size: 1rem; }
        .avatar-frame {
            width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2a, #111);
            border: 2px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; margin: 0 auto 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-student { border-color: var(--accent-primary); color: var(--accent-primary); }
        .avatar-teacher { border-color: var(--accent-gold); color: var(--accent-gold); }
        .mini-frame { width: 40px; height: 40px; font-size: 1.2rem; margin: 0; border-width: 1px; }

        /* Dardasha Styles */
        .chat-section-container {
            padding-top: calc(var(--nav-height) + 10px) !important;
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            margin: 0 auto;
        }

        .chat-layout {
            display: flex; 
            flex: 1;
            background: #000; 
            position: relative; 
            overflow: hidden;
            margin-bottom: 10px;
        }
        .chat-sidebar {
            width: 100%; height: 100%; background: #111; border-left: 1px solid #333; display: flex; flex-direction: column;
        }

        /* MOBILE CHAT FIX - FULL SCREEN */
        @media (max-width: 768px) {
            .chat-layout {
                margin: 0;
                border: none;
                border-radius: 0;
            }
            .chat-sidebar {
                width: 100%;
                height: 100%;
                border: none;
            }
            .chat-window {
                position: absolute; 
                inset: 0; 
                z-index: 2001; 
                background: #000; 
                display: flex; 
                flex-direction: column;
                height: 100%;
                width: 100%;
            }
            .chat-section-container {
                 padding-left: 0; padding-right: 0;
            }
        }

        @media (min-width: 768px) { .chat-sidebar { width: 350px; flex-shrink: 0; } .chat-layout { border: 1px solid #333; border-radius: 20px; margin-top: 5px; } }
        .chat-sidebar-header {
            padding: 15px; background: #181818; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222;
        }
        .my-chat-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .chat-search-bar { padding: 10px; background: #111; border-bottom: 1px solid #222; position: relative; display: flex; gap: 8px;}
        .chat-search-bar input { width: 100%; background: #202020; border: none; padding: 10px 40px 10px 15px; border-radius: 12px; color: #fff; transition: all 0.3s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .chat-search-bar input:focus {
            background: #000;
            border: 1px solid var(--accent-primary);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4), inset 0 1px 1px rgba(0,0,0,0.5);
            transform: scale(1.01);
        }
        .chat-search-bar i.search-icon-inside { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;}
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item {
            display: flex; padding: 12px; gap: 12px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #1a1a1a;
        }
        .chat-item:hover { background: #1a1a1a; }
        .chat-window {
            background: var(--bg-deep); display: flex; flex-direction: column;
        }
        @media (min-width: 768px) { .chat-window { position: static; flex: 1; } }
        .chat-header {
            padding: 10px 15px; background: #181818; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #222;
        }
        .chat-msgs-area { flex: 1; overflow-y: auto; padding: 15px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: soft-light; background-color: #0b0b0b; }
        .chat-input-area { padding: 10px; background: #181818; display: flex; align-items: center; gap: 10px; }
        .chat-input-area input { flex: 1; background: #2a2a2a; border: none; padding: 12px; border-radius: 20px; color: #fff; outline: none; }
        .msg-bubble {
            max-width: 75%; padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; font-size: 0.95rem; position: relative; word-wrap: break-word; line-height: 1.4;
        }
        .msg-bubble.sent { background: var(--chat-bubble-sent); align-self: flex-end; border-top-left-radius: 0; margin-left: auto; color: #e9edef; }
        .msg-bubble.recv { background: var(--chat-bubble-recv); align-self: flex-start; border-top-right-radius: 0; margin-right: auto; color: #e9edef; }
        .msg-time { font-size: 0.65rem; color: rgba(255,255,255,0.6); text-align: left; margin-top: 4px; }
        .whatsapp-img { border-radius: 8px; max-width: 100%; margin-bottom: 5px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .copy-box { background: #111; padding: 10px; border: 1px dashed #444; border-radius: 8px; margin-top: 5px; font-family: monospace; color: var(--accent-primary); cursor: pointer; }

        /* End Dardasha */
        
        /* New Magic Search Button */
        .magic-search-btn {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white;
            border: none;
            width: 50px;
            height: 40px; /* Match input height roughly */
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: pulse-glow 2s infinite;
        }

        .magic-search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.6);
            background: linear-gradient(135deg, #4f46e5, #9333ea);
        }

        .magic-search-btn:active {
            transform: scale(0.95);
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); }
            100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); }
        }


        .reese-input-trigger {
            background: linear-gradient(135deg, #181818, #101010);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px; padding: 12px;
            display: flex; align-items: center; gap: 15px;
            cursor: pointer; margin-bottom: 25px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        .reese-input-trigger:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.15); }
        .reese-input-trigger::before {
            content: ''; position: absolute; top:0; left:0; width:4px; height:100%;
            background: linear-gradient(to bottom, var(--accent-primary), var(--accent-gold));
        }
        .reese-avatar-mini {
            width: 45px; height: 45px; border-radius: 50%;
            background: #252525; display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 1.2rem; flex-shrink: 0;
        }
        .reese-placeholder { flex: 1; color: #666; font-size: 1rem; font-weight: 500; }
        .reese-icon-decor { color: var(--accent-primary); font-size: 1.2rem; opacity: 0.8; padding-left: 10px; }
        .reese-card {
            background: #111;
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px; padding: 15px; margin-bottom: 15px;
            transition: 0.2s; position: relative;
        }
        .reese-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .reese-user { display: flex; gap: 10px; align-items: center; }
        .reese-content { font-size: 0.95rem; line-height: 1.6; color: #eee; margin-bottom: 15px; white-space: pre-wrap; word-wrap: break-word; }
        .reese-images-grid {
            display: grid; gap: 5px; border-radius: 12px; overflow: hidden; margin-top: 10px;
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);
        }
        .reese-images-grid.one-img { grid-template-columns: 1fr; }
        .reese-images-grid.two-imgs { grid-template-columns: 1fr 1fr; }
        .reese-post-img { width: 100%; height: 100%; object-fit: cover; max-height: 400px; background: #222; }
        .reese-actions {
            border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;
            display: flex; justify-content: space-around;
        }
        .reese-btn {
            background: transparent; border: none; color: #888;
            font-size: 0.9rem; display: flex; align-items: center; gap: 6px;
            cursor: pointer; transition: 0.2s; padding: 5px 10px; border-radius: 20px;
        }
        .reese-btn:hover { background: rgba(255,255,255,0.05); color: #ccc; }
        .reese-btn.liked { color: var(--fb-red); }
        .reese-btn.liked i { animation: pop 0.3s; }
        @keyframes pop { 0%{transform:scale(1);} 50%{transform:scale(1.3);} 100%{transform:scale(1);} }
        .compose-overlay {
            position: fixed; inset: 0; background: #000; z-index: 6000;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .compose-overlay.open { transform: translateY(0); }
        .compose-header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .compose-body { padding: 20px; flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .compose-textarea {
            width: 100%; background: transparent; border: none; color: #fff;
            font-size: 1.2rem; font-family: var(--font-main); resize: none;
            outline: none; margin-top: 10px; min-height: 100px; overflow: hidden;
        }
        .ai-suggestion-btn {
            background: linear-gradient(45deg, #d946ef, #8b5cf6); color: white;
            border: none; padding: 8px 15px; border-radius: 20px;
            font-size: 0.85rem; display: flex; align-items: center; gap: 5px;
            width: fit-content; margin-bottom: 15px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(217, 70, 239, 0.3);
        }
        .ai-suggestions-container {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
        }
        .suggestion-chip {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1);
            color: #ddd; padding: 8px 12px; border-radius: 12px; font-size: 0.8rem;
            cursor: pointer; transition: 0.2s; max-width: 100%; white-space: normal;
            display: inline-block; line-height: 1.4;
        }
        .suggestion-chip:hover {
            background: rgba(255,255,255,0.15); border-color: var(--accent-primary);
            color: #fff; transform: translateY(-2px);
        }
        .suggestion-chip i { color: var(--accent-primary); margin-left: 5px; }

        .compose-media-preview { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; }
        .preview-item { position: relative; width: 100px; height: 100px; border-radius: 12px; overflow: hidden; border: 1px solid #333; flex-shrink: 0; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-preview {
            position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6);
            color: #fff; border-radius: 50%; width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;
        }
        .add-media-btn {
            background: linear-gradient(135deg, #ff00cc, #333399); color: #fff;
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; margin-right: 15px;
            box-shadow: 0 0 15px rgba(255, 0, 204, 0.5);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .add-media-btn:hover { transform: scale(1.1) rotate(5deg); box-shadow: 0 0 25px rgba(255, 0, 204, 0.8); }
        .ai-layout {
            position: fixed; top: var(--nav-height); left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; background: var(--bg-deep); z-index: 100;
        }
        .ai-top-bar {
            padding: 10px 15px; background: #000 !important;
            border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center; z-index: 101;
        }
        .ai-action-btn {
            background: rgba(255,255,255,0.05); color: #ccc;
            border: 1px solid transparent; border-radius: 50%;
            width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .ai-action-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .ai-action-btn.new-chat { color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
        .ai-action-btn.history { color: var(--accent-gold); }
        .ai-action-btn.incognito.active { color: #fff; background: var(--danger); box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        .ai-messages {
            flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px;
            display: flex; flex-direction: column; gap: 12px;
        }
        .ai-welcome-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; opacity: 0; animation: fadeIn 0.8s forwards; padding: 20px; text-align: center;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .ai-logo-large {
            width: 80px; height: 80px; border-radius: 50%;
            background: #111; border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; color: #d946ef; margin-bottom: 20px;
            box-shadow: 0 0 50px rgba(217, 70, 239, 0.2);
        }
        .ai-welcome-title {
            font-size: 1.5rem; font-weight: 800; margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #a0a0a0); -webkit-background-clip: text; color: transparent;
        }
        .ai-welcome-text { color: #666; font-size: 0.95rem; max-width: 300px; margin-bottom: 40px; }
        .ai-chips { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 100%; max-width: 500px; }
        .ai-chip {
            background: #1a1a1a; border: 1px solid #333; color: #ccc;
            padding: 10px 15px; border-radius: 12px; font-size: 0.85rem;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .ai-chip i { color: var(--accent-primary); }
        .ai-chip:hover { background: #252525; border-color: #555; color: #fff; transform: translateY(-2px); }
        .chat-msg {
            max-width: 85%; padding: 12px 18px; border-radius: 18px;
            font-size: 0.95rem; line-height: 1.6; position: relative; word-wrap: break-word;
        }
        .chat-msg.ai {
            background: #1a1a1a; align-self: flex-start; border-bottom-left-radius: 4px; color: #e0e0e0;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .chat-msg.user {
            background: var(--accent-primary); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; font-weight: 500;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .chat-msg img { max-width: 100%; border-radius: 10px; margin-top: 10px; display: block; }

        .chat-msg strong { font-weight: 700; color: #fff; }
        .chat-msg ul { margin: 5px 0; padding-right: 20px; }
        .chat-msg li { margin-bottom: 4px; }
        .chat-msg code { background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .chat-msg pre { background: #111; padding: 10px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; }
        .chat-msg pre code { background: transparent; padding: 0; }

        .ai-input-bar {
            position: fixed; bottom: 25px; left: 15px; right: 15px;
            background: #000; border: 1px solid rgba(255,255,255,0.15);
            border-radius: 25px; padding: 10px;
            display: flex; align-items: center; gap: 10px; z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            max-width: 800px; margin: 0 auto;
        }
        .ai-input-field {
            flex: 1; background: #111; border: 1px solid #333; border-radius: 20px;
            color: #fff; font-family: var(--font-main); font-size: 1rem;
            outline: none; padding: 10px 15px;
        }
        .attach-btn { color: #aaa; font-size: 1.3rem; padding: 0 10px; cursor: pointer; transition: 0.3s; }
        .attach-btn:hover { color: #fff; }
        .send-btn {
            background: var(--accent-primary); color: #fff; border: none;
            width: 42px; height: 42px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.1rem; transition: 0.3s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .send-btn:active { transform: scale(0.9); }
        .chat-img-preview {
            position: absolute; bottom: 85px; left: 0;
            background: #222; padding: 5px; border-radius: 10px;
            border: 1px solid var(--glass-border);
            display: none; z-index: 2001;
        }
        .chat-img-preview img { height: 60px; border-radius: 6px; }
        .chat-img-preview i { 
            position: absolute; top: -8px; right: -8px; 
            background: red; color: white; border-radius: 50%; width: 20px; height: 20px; 
            display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer;
        }
        .ai-history-sidebar {
            position: fixed; top: 0; right: -300px; width: 300px; bottom: 0;
            background: #111; border-left: 1px solid #333; z-index: 5000;
            transition: 0.3s; display: flex; flex-direction: column;
            padding-top: var(--nav-height);
        }
        .ai-history-sidebar.open { right: 0; }
        .history-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item {
            padding: 12px; margin-bottom: 8px; border-radius: 10px;
            background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-item:hover { background: rgba(255,255,255,0.08); }
        .history-title { font-size: 0.9rem; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .history-date { font-size: 0.7rem; color: #666; margin-top: 4px; display: block; }
        .full-screen-overlay {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto; padding-bottom: 40px;
        }
        .full-screen-overlay.open { transform: translateY(0); }
        .overlay-content { padding: 40px 20px; flex: 1; display: flex; flex-direction: column; gap: 20px; padding-top: 60px; }
        .menu-item {
            background: rgba(255,255,255,0.03); padding: 16px;
            border-radius: 16px; display: flex; align-items: center; gap: 15px;
            margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.3s;
        }
        .menu-item:active { background: rgba(255,255,255,0.08); }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; margin-bottom: 20px; }
        .avatar-option {
            background: #222; border-radius: 50%; aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; cursor: pointer; border: 2px solid transparent;
        }
        .avatar-option.selected { border-color: var(--success); background: #000; }
        #phone-modal, #teacher-detail-modal, #profile-info-modal, #user-search-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        .bottom-sheet-content {
            background: #181818; border-top: 1px solid #333;
            border-radius: 25px 25px 0 0; padding: 25px; padding-bottom: 50px;
            animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        #landing-layer {
            position: fixed; inset: 0; z-index: 5000;
            background: url('https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2070&auto=format&fit=crop') no-repeat center center/cover;
        }
        #landing-layer::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0.6) 100%);
        }
        .landing-wrap {
            position: relative; z-index: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; text-align: center; padding: 30px;
        }
        .role-toggle-container {
            display: flex; background: #222; padding: 5px; border-radius: 50px;
            margin-bottom: 20px; width: 100%; max-width: 400px;
        }
        .role-toggle-btn {
            flex: 1; border: none; background: transparent; color: #888;
            padding: 10px; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .role-toggle-btn.active { background: #fff; color: #000; box-shadow: 0 2px 10px rgba(255,255,255,0.2); }
        .option-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .option-radio { width: 20px; height: 20px; accent-color: var(--success); cursor: pointer; }
        .option-input { flex: 1; margin: 0; border: 1px solid #333; }
        .option-input.correct { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .ad-banner {
            width: 100%; display: flex; justify-content: center; align-items: center;
            margin: 20px 0; overflow-x: auto; border-radius: 8px;
            background: rgba(255,255,255,0.02); padding: 10px; border: 1px dashed rgba(255,255,255,0.05);
        }
        .skeleton-loader {
            background: #151515; border: 1px solid rgba(255,255,255,0.05);
            border-radius: 15px; padding: 15px; margin-bottom: 15px; position: relative; overflow: hidden;
        }
        .skeleton-loader::after {
            content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.05) 20%, rgba(255,255,255,0) 60%);
            transform: translateX(100%); animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(-100%); } }
        .skeleton-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .skeleton-circle { width: 40px; height: 40px; background: #222; border-radius: 50%; }
        .skeleton-text { flex: 1; }
        .skeleton-line { height: 10px; background: #222; border-radius: 5px; margin-bottom: 8px; }
        .skeleton-line.short { width: 50%; }
        .skeleton-rect { height: 100px; background: #222; border-radius: 10px; width: 100%; }
        #sa-custom-alert {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #sa-custom-alert.active { opacity: 1; pointer-events: auto; }
        .sa-alert-box {
            background: #1a1a1a; border: 1px solid var(--glass-border);
            border-radius: 25px; padding: 25px; width: 90%; max-width: 400px;
            text-align: center; transform: scale(0.9); transition: 0.3s;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #sa-custom-alert.active .sa-alert-box { transform: scale(1); }
        .sa-alert-icon { font-size: 3rem; margin-bottom: 15px; }
        .sa-alert-title { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .sa-alert-msg { color: #aaa; margin-bottom: 25px; line-height: 1.5; font-size: 0.95rem; }
        .sa-alert-actions { display: flex; gap: 10px; justify-content: center; }
        .sa-btn { padding: 10px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; border: none; flex: 1; }
        .sa-btn-primary { background: var(--accent-primary); color: #fff; }
        .sa-btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .empty-state-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px 20px; text-align: center; opacity: 0; animation: fadeIn 0.5s forwards;
        }
        .empty-avatar {
            font-size: 4rem; color: #333; margin-bottom: 20px;
            background: #111; width: 100px; height: 100px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px dashed #444; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .type-toggle-container {
            display: flex; gap: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.05);
            padding: 5px; border-radius: 12px; width: fit-content;
        }
        .type-radio-label {
            padding: 8px 15px; border-radius: 8px; cursor: pointer; color: #888; transition: 0.3s; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px;
        }
        .type-radio-label:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .type-radio-label.active { background: var(--accent-primary); color: #fff; }
        .type-radio-input { display: none; }

        #construction-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.5s;
        }
        #construction-overlay.active { opacity: 1; pointer-events: auto; }
        .construction-loader {
            width: 80px; height: 80px; position: relative; margin-bottom: 30px;
        }
        .construction-loader::before, .construction-loader::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            border: 3px solid transparent; border-top-color: var(--accent-primary);
            animation: spin 1.5s linear infinite;
        }
        .construction-loader::after {
            inset: 10px; border-top-color: var(--accent-gold); animation-duration: 2.5s;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .construction-text { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: bold; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
        .construction-sub { color: #888; font-size: 0.9rem; margin-top: 10px; }

        #pwa-install-banner {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; padding: 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10000; transform: translateY(200%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #pwa-install-banner.visible { transform: translateY(0); }
        .pwa-content { display: flex; align-items: center; gap: 15px; }
        .pwa-icon { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; }
        .pwa-info h4 { margin: 0; color: #fff; font-size: 1rem; }
        .pwa-info p { margin: 2px 0 0; color: #aaa; font-size: 0.8rem; }
        .pwa-actions { display: flex; gap: 10px; }
        .pwa-btn { padding: 8px 16px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
        .pwa-btn.install { background: var(--accent-primary); color: white; }
        .pwa-btn.close { background: rgba(255,255,255,0.1); color: #fff; }
    </style>
</head>
<body>
    <div id="construction-overlay">
        <div class="construction-loader"></div>
        <div class="construction-text">SA AI Building...</div>
        <div class="construction-sub">جاري بناء وتجهيز البيانات</div>
    </div>

    <!-- Hidden by default to prevent flash -->
    <div id="landing-layer" class="hidden">
        <div class="landing-wrap">
            <h1 style="font-size: 3.5rem; background: linear-gradient(to right, #fff, #3b82f6); -webkit-background-clip: text; color: transparent; margin: 0; text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);">SA EDU</h1>
            <div style="min-height: 40px; margin-top: 10px; display:flex; justify-content:center; align-items:center; gap:5px;">
                <span id="landing-type-text" class="landing-text"></span><span class="typewriter-cursor"></span>
            </div>
            <div style="margin-top: 30px;">
                <img src="https://i.postimg.cc/BQQb5YDn/MOWU-DESIGN.png" class="landing-avatar-img" alt="Logo">
            </div>
            <button onclick="goToAuth()" class="modern-btn" style="margin-top: 50px; font-size: 1.1rem; background: #ffffff; color: #000000; border: none; box-shadow: 0 0 30px rgba(255, 255, 255, 0.2); font-weight: 800; font-family: 'Outfit', sans-serif;">
                ENTER THE REALM <i class="fas fa-dungeon" style="margin-left: 8px;"></i>
            </button>
        </div>
    </div>

    <div id="auth-layer" class="hidden">
        <div class="flex-center" style="height: 100%; flex-direction: column; padding: 30px;">
            <div onclick="backToLanding()" style="position: absolute; top: 40px; right: 30px; cursor: pointer; padding: 10px;"><i class="fas fa-arrow-right fa-xl"></i></div>
            <h2 style="margin: 0 0 30px;">بوابة الدخول</h2>
            <div class="role-toggle-container">
                <button class="role-toggle-btn active" id="btn-role-student" onclick="setAuthRole('student')">طالب</button>
                <button class="role-toggle-btn" id="btn-role-teacher" onclick="setAuthRole('teacher')">معلم</button>
            </div>
            <div id="auth-avatar-display" class="avatar-frame avatar-student" style="margin-bottom: 30px;">
                <i class="fas fa-user-astronaut"></i>
            </div>
            <div class="names-row">
                <input type="text" id="auth-name-1" class="smart-input" placeholder="الاسم الأول" style="text-align: center;">
                <input type="text" id="auth-name-2" class="smart-input" placeholder="الاسم الثاني" style="text-align: center;">
            </div>
            <input type="text" id="auth-name-3" class="smart-input" placeholder="الاسم الثالث" style="text-align: center;">
            <input type="password" id="auth-pass" class="smart-input" placeholder="الرمز السري (6 خانات)" maxlength="6" style="text-align: center;">
            <button onclick="handleSmartAuth()" class="modern-btn" style="margin-top: 50px;">
                تسجيل الدخول <i class="fas fa-sign-in-alt"></i>
            </button>
            <div id="auth-status" style="margin-top: 20px; color: var(--warning); font-size: 0.9rem;"></div>
        </div>
    </div>

    <!-- AI History Sidebar -->
    <div id="ai-history-sidebar" class="ai-history-sidebar">
        <div class="history-header">
            <span style="font-weight:bold; color:#fff;">سجل المحادثات</span>
            <i class="fas fa-times" onclick="toggleHistory(false)" style="cursor:pointer; color:#888;"></i>
        </div>
        <div class="history-list" id="ai-history-list"></div>
    </div>

    <!-- Teacher App -->
    <div id="teacher-app" class="hidden">
        <nav class="top-nav">
            <div class="nav-container">
                <button class="nav-btn active" onclick="switchTab('t-library', this)"><i class="fas fa-layer-group"></i><span>المكتبة</span></button>
                <button class="nav-btn" onclick="switchTab('t-reese', this)"><i class="fas fa-feather-alt"></i><span>ريس</span></button>
                <button class="nav-btn" onclick="switchTab('t-dardasha', this)"><i class="fab fa-telegram-plane"></i><span>دردشة</span></button>
                <button class="nav-btn magic-btn" onclick="switchTab('t-ai', this)"><i class="fas fa-wand-magic-sparkles"></i><span>AI</span></button>
                <button class="nav-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i><span>القائمة</span></button>
            </div>
        </nav>
        <div class="portal-container">
            <!-- T-Library Section -->
            <section id="t-library" class="app-section">
                <div class="create-exam-cta" onclick="switchTab('t-create')">
                    <i class="fas fa-file-signature cta-bg-icon"></i>
                    <div class="cta-content">
                        <div class="cta-icon-wrapper"><i class="fas fa-plus"></i></div>
                        <div style="text-align: right; flex: 1;">
                            <div style="display:flex; align-items:center; gap:3px;">
                                <h3 id="cta-type-text" class="typewriter-text"></h3><span class="typewriter-cursor"></span>
                            </div>
                            <p style="margin: 4px 0 0; color: #ccc; font-size: 0.85rem;">انقر للبدء في إنشاء اختبار جديد للطلاب</p>
                        </div>
                    </div>
                    <div style="color: #666; position:relative; z-index:2;"><i class="fas fa-chevron-left"></i></div>
                </div>
                <div class="search-wrap">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="google-bar" id="t-search" placeholder="ابحث في اختباراتك...">
                </div>
                <div id="t-tests-list"></div>
            </section>

            <!-- T-Reese Section -->
            <section id="t-reese" class="app-section hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin:0; font-family:'Outfit', sans-serif;">Reese SA</h2>
                    <button class="icon-btn-small" style="background:rgba(255,255,255,0.05); width:40px; height:40px;" onclick="toggleMyPostsView()">
                        <i class="fas fa-eraser" id="t-eraser-icon" style="color:#aaa;"></i>
                    </button>
                </div>
                <div class="reese-input-trigger" onclick="openReeseCompose()">
                    <div class="reese-avatar-mini" id="reese-trigger-avatar-t"></div>
                    <div class="reese-placeholder">ماذا يدور في ذهنك اليوم؟</div>
                    <i class="fas fa-pen-nib reese-icon-decor"></i>
                </div>
                <div id="reese-feed-container-t"></div>
            </section>

            <!-- T-Dardasha Section -->
            <section id="t-dardasha" class="app-section hidden chat-section-container">
                <!-- NEW BACK BUTTON ADDED HERE -->
                <div class="back-btn-header" style="margin: 0 15px 10px;" onclick="switchTab('t-library')"><i class="fas fa-arrow-right"></i> الرئيسية</div>
                
                <div class="chat-layout">
                    <div class="chat-sidebar" id="t-chat-sidebar">
                        <div class="chat-sidebar-header">
                            <div class="my-chat-info" onclick="openMyProfileModal()">
                                <div class="avatar-frame mini-frame" id="t-chat-my-avatar"></div>
                                <span>دردشة</span>
                            </div>
                            <button class="icon-btn-small" onclick="toggleUserSearchModal()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="chat-search-bar">
                            <i class="fas fa-search search-icon-inside"></i>
                            <input type="text" placeholder="بحث في المحادثات..." onkeyup="filterChats('t', this.value)">
                        </div>
                        <div class="chat-list" id="t-chat-list"></div>
                    </div>
                    <div class="chat-window hidden" id="t-chat-window">
                        <!-- Content injected by JS -->
                    </div>
                </div>
            </section>

            <!-- T-Results Section -->
            <section id="t-results" class="app-section hidden">
                <div class="back-btn-header" onclick="switchTab('t-library')"><i class="fas fa-arrow-right"></i> الرئيسية</div>
                <h2>نتائج الطلاب</h2>
                <select id="t-result-select" class="smart-input" style="text-align: right;"><option>اختر الاختبار للعرض</option></select>
                <div id="t-results-container"></div>
            </section>

            <!-- T-Create Section -->
            <section id="t-create" class="app-section hidden">
                <div class="back-btn-header" onclick="resetCreateForm(); switchTab('t-library');"><i class="fas fa-arrow-right"></i> إلغاء</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;" id="create-page-title">اختبار جديد</h2>
                    <button onclick="toggleAiGenerator()" style="background: rgba(217, 70, 239, 0.1); border: 1px solid #d946ef; color: #d946ef; padding: 6px 15px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; font-weight: bold;">
                        <i class="fas fa-wand-magic-sparkles"></i> توليد بالـ AI
                    </button>
                </div>
                <input type="text" id="new-test-name" class="smart-input" placeholder="عنوان الاختبار (مثال: فيزياء - الوحدة الأولى)" style="font-weight: bold;">
                <div style="display: flex; gap: 10px;">
                    <select id="new-test-grade" class="smart-input" onchange="checkCustomGrade(this)">
                        <option value="" disabled selected>الصف الدراسي</option>
                        <option value="1p">الأول الابتدائي</option>
                        <option value="2p">الثاني الابتدائي</option>
                        <option value="3p">الثالث الابتدائي</option>
                        <option value="4p">الرابع الابتدائي</option>
                        <option value="5p">الخامس الابتدائي</option>
                        <option value="6p">السادس الابتدائي</option>
                        <option value="1m">الأول الإعدادي</option>
                        <option value="2m">الثاني الإعدادي</option>
                        <option value="3m">الثالث الإعدادي</option>
                        <option value="1s">الأول الثانوي</option>
                        <option value="2s">الثاني الثانوي</option>
                        <option value="3s">الثالث الثانوي</option>
                        <option value="custom" style="color: var(--accent-gold);">-- كتابة صف مخصص --</option>
                    </select>
                    <input type="number" id="new-test-duration" class="smart-input" placeholder="المدة (د)" style="width: 100px; text-align: center;">
                </div>
                <input type="text" id="custom-grade-input" class="smart-input hidden" placeholder="اكتب اسم الصف هنا..." style="border-color: var(--accent-gold);">
                <div id="q-editor-box" style="background: #151515; padding: 20px; border-radius: 20px; border: 1px solid #333; margin-top: 20px;">
                    <h3 style="font-size: 1rem; color: #888; margin-top: 0; margin-bottom: 15px;">إضافة سؤال</h3>
                    
                    <div class="type-toggle-container">
                        <label class="type-radio-label active" onclick="setQType('mcq', this)">
                            <i class="fas fa-list-ul"></i> اختياري
                            <input type="radio" name="q-type" value="mcq" class="type-radio-input" checked>
                        </label>
                        <label class="type-radio-label" onclick="setQType('essay', this)">
                            <i class="fas fa-align-right"></i> مقالي
                            <input type="radio" name="q-type" value="essay" class="type-radio-input">
                        </label>
                    </div>

                    <textarea id="q-text" class="smart-input" rows="2" placeholder="اكتب نص السؤال"></textarea>
                    
                    <div id="mcq-section-wrapper">
                        <div id="mcq-options-container"></div>
                        <button onclick="addOptionField()" class="modern-btn secondary" style="width: auto; padding: 8px 15px; font-size: 0.8rem; margin-bottom: 15px;">
                            <i class="fas fa-plus"></i> إضافة خيار آخر
                        </button>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px; border-top: 1px solid #333; padding-top: 15px;">
                        <input type="number" id="q-points" value="1" class="smart-input" style="width: 80px; text-align: center; margin:0;" placeholder="درجة">
                        <label class="smart-input" style="flex: 1; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; border: 1px dashed #444; margin:0;">
                            <i class="fas fa-image"></i> <span id="q-img-label">إرفاق صورة</span>
                            <input type="file" id="q-image-input" hidden accept="image/*">
                        </label>
                    </div>
                    <div id="q-img-preview" class="hidden" style="margin-top: 10px; text-align: center;"><img src="" style="height: 80px; border-radius: 10px;"></div>
                    <button id="btn-add-q" onclick="addQuestionToList()" class="modern-btn" style="margin-top: 15px; background: #333; color: #fff;">
                        <i class="fas fa-check"></i> إضافة السؤال
                    </button>
                </div>
                <h3 style="margin-top: 30px; margin-bottom: 10px;">الأسئلة المضافة:</h3>
                <div id="added-questions-list" style="margin-bottom: 30px;"></div>
                <button id="btn-save-test" class="modern-btn" onclick="saveTest()" style="background: var(--success); color: white; margin-bottom: 50px;">
                    <i class="fas fa-save"></i> نشر الاختبار النهائي
                </button>
            </section>

            <!-- T-AI Section -->
            <section id="t-ai" class="app-section hidden">
                <div class="ai-layout">
                    <div class="ai-top-bar">
                        <div style="display:flex; gap:10px;">
                            <button class="ai-action-btn new-chat" onclick="startNewChat('t')" title="محادثة جديدة"><i class="fas fa-plus"></i></button>
                            <button class="ai-action-btn history" onclick="toggleHistory(true)" title="السجل"><i class="fas fa-history"></i></button>
                            <button class="ai-action-btn incognito" id="t-incognito-btn" onclick="toggleIncognito('t')" title="محادثة مخفية"><i class="fas fa-user-secret"></i></button>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="ai-action-btn" onclick="shareCurrentChat()" title="مشاركة المحادثة"><i class="fas fa-share-nodes"></i></button>
                        </div>
                    </div>
                    <div class="ai-messages" id="t-ai-msgs"></div>
                </div>
                <div class="ai-input-bar">
                    <label for="t-ai-file" class="attach-btn"><i class="fas fa-paperclip"></i></label>
                    <input type="file" id="t-ai-file" hidden accept="image/*" onchange="previewChatImg('t')">
                    <input type="text" id="t-ai-input" class="ai-input-field" placeholder="اكتب رسالة (مثال: أنشئ اختبار عن...)">
                    <button onclick="sendAiMsg('t')" class="send-btn"><i class="fas fa-arrow-up"></i></button>
                    <div id="t-chat-preview" class="chat-img-preview">
                        <i class="fas fa-times" onclick="clearChatImg('t')"></i>
                        <img src="" id="t-chat-img-tag">
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Student App -->
    <div id="student-app" class="hidden">
        <nav class="top-nav">
            <div class="nav-container">
                <button class="nav-btn active" onclick="switchTab('s-exams', this)"><i class="fas fa-book-open"></i><span>اختبارات</span></button>
                <button class="nav-btn" onclick="switchTab('s-reese', this)"><i class="fas fa-feather-alt"></i><span>ريس</span></button>
                <button class="nav-btn" onclick="switchTab('s-dardasha', this)"><i class="fab fa-telegram-plane"></i><span>دردشة</span></button>
                <button class="nav-btn magic-btn" onclick="switchTab('s-ai', this)"><i class="fas fa-wand-magic-sparkles"></i><span>AI</span></button>
                <button class="nav-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i><span>القائمة</span></button>
            </div>
        </nav>
        <div class="portal-container">
            <!-- S-Exams Section -->
            <section id="s-exams" class="app-section">
                <div class="search-wrap">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="google-bar" id="s-search" placeholder="ابحث عن اختبار...">
                </div>
                <div class="create-exam-cta" style="margin-bottom: 20px; cursor: default; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(16, 185, 129, 0.05)); border-color: rgba(255,255,255,0.1);">
                    <i class="fas fa-brain cta-bg-icon"></i>
                    <div class="cta-content">
                        <div class="cta-icon-wrapper" style="background: var(--accent-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);"><i class="fas fa-lightbulb"></i></div>
                        <div style="text-align: right; flex: 1;">
                            <div style="display:flex; align-items:center; gap:3px;">
                                <h3 id="student-type-text" class="typewriter-text"></h3><span class="typewriter-cursor"></span>
                            </div>
                            <div style="margin-top: 5px; display: inline-block; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 8px; font-size: 0.75rem; color: #aaa;">
                                <i class="fas fa-university"></i> منصة SA EDU
                            </div>
                        </div>
                    </div>
                </div>
                <div id="s-exams-list"></div>
            </section>

            <!-- S-Reese Section -->
            <section id="s-reese" class="app-section hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin:0; font-family:'Outfit', sans-serif;">Reese SA</h2>
                    <button class="icon-btn-small" style="background:rgba(255,255,255,0.05); width:40px; height:40px;" onclick="toggleMyPostsView()">
                        <i class="fas fa-eraser" id="s-eraser-icon" style="color:#aaa;"></i>
                    </button>
                </div>
                <div class="reese-input-trigger" onclick="openReeseCompose()">
                    <div class="reese-avatar-mini" id="reese-trigger-avatar-s"></div>
                    <div class="reese-placeholder">شارك أفكارك مع الجميع...</div>
                    <i class="fas fa-pen-nib reese-icon-decor"></i>
                </div>
                <div id="reese-feed-container-s"></div>
            </section>

            <!-- S-Dardasha Section -->
            <section id="s-dardasha" class="app-section hidden chat-section-container">
                <!-- NEW BACK BUTTON ADDED HERE -->
                <div class="back-btn-header" style="margin: 0 15px 10px;" onclick="switchTab('s-exams')"><i class="fas fa-arrow-right"></i> الرئيسية</div>
                
                <div class="chat-layout">
                    <div class="chat-sidebar" id="s-chat-sidebar">
                        <div class="chat-sidebar-header">
                            <div class="my-chat-info" onclick="openMyProfileModal()">
                                <div class="avatar-frame mini-frame" id="s-chat-my-avatar"></div>
                                <span>دردشة</span>
                            </div>
                            <button class="icon-btn-small" onclick="toggleUserSearchModal()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="chat-search-bar">
                            <i class="fas fa-search search-icon-inside"></i>
                            <input type="text" placeholder="بحث في المحادثات..." onkeyup="filterChats('s', this.value)">
                        </div>
                        <div class="chat-list" id="s-chat-list"></div>
                    </div>
                    <div class="chat-window hidden" id="s-chat-window"></div>
                </div>
            </section>

            <!-- S-Grades Section -->
            <section id="s-grades" class="app-section hidden">
                <h2 style="margin-bottom: 20px;">لوحة الشرف (درجاتي)</h2>
                <div id="s-grades-list"></div>
            </section>

            <!-- S-AI Section -->
            <section id="s-ai" class="app-section hidden">
                <div class="ai-layout">
                    <div class="ai-top-bar">
                        <div style="display:flex; gap:10px;">
                            <button class="ai-action-btn new-chat" onclick="startNewChat('s')" title="محادثة جديدة"><i class="fas fa-plus"></i></button>
                            <button class="ai-action-btn history" onclick="toggleHistory(true)" title="السجل"><i class="fas fa-history"></i></button>
                            <button class="ai-action-btn incognito" id="s-incognito-btn" onclick="toggleIncognito('s')" title="محادثة مخفية"><i class="fas fa-user-secret"></i></button>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="ai-action-btn" onclick="shareCurrentChat()" title="مشاركة المحادثة"><i class="fas fa-share-nodes"></i></button>
                        </div>
                    </div>
                    <div class="ai-messages" id="s-ai-msgs"></div>
                </div>
                <div class="ai-input-bar">
                    <label for="s-ai-file" class="attach-btn"><i class="fas fa-paperclip"></i></label>
                    <input type="file" id="s-ai-file" hidden accept="image/*" onchange="previewChatImg('s')">
                    <input type="text" id="s-ai-input" class="ai-input-field" placeholder="اسألني عن أي شيء...">
                    <button onclick="sendAiMsg('s')" class="send-btn"><i class="fas fa-arrow-up"></i></button>
                    <div id="s-chat-preview" class="chat-img-preview">
                        <i class="fas fa-times" onclick="clearChatImg('s')"></i>
                        <img src="" id="s-chat-img-tag">
                    </div>
                </div>
            </section>

            <!-- S-Taking Test Overlay -->
            <section id="s-taking-test" class="app-section hidden" style="position: fixed; inset: 0; background: #000; z-index: 3000; padding: 20px; overflow-y: auto;">
                <div style="max-width: 800px; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="back-btn-header" onclick="closeExam()"><i class="fas fa-sign-out-alt"></i> خروج</button>
                        <div id="test-timer" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);">00:00</div>
                    </div>
                    <h2 id="active-test-title" style="text-align: center; color: var(--accent-gold); margin-bottom: 30px;">...</h2>
                    <div id="test-questions-render" style="margin-bottom: 60px;"></div>
                    <button onclick="submitExam()" class="modern-btn" style="background: var(--success); color: white; margin-bottom: 50px;">تسليم الإجابة</button>
                </div>
            </section>
            
            <!-- S-Review Test Overlay -->
            <section id="s-review-test" class="app-section hidden" style="position: fixed; inset: 0; background: #000; z-index: 3000; padding: 20px; overflow-y: auto;">
                <div style="max-width: 800px; margin: auto;">
                    <div class="back-btn-header" onclick="document.getElementById('s-review-test').classList.add('hidden')"><i class="fas fa-arrow-right"></i> إغلاق المراجعة</div>
                    <h2 style="color: var(--accent-primary);">مراجعة الإجابات</h2>
                    <div id="review-content"></div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div id="reese-compose-modal" class="compose-overlay">
        <div class="compose-header">
            <span style="font-weight: bold; font-size: 1.1rem;">إنشاء ريس جديد</span>
            <div style="cursor: pointer; padding: 10px;" onclick="closeReeseCompose()"><i class="fas fa-arrow-right fa-lg"></i></div>
        </div>
        <div class="compose-body">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div class="avatar-frame" id="compose-avatar" style="width: 50px; height: 50px; font-size: 1.5rem; margin: 0; border-width: 1px;"></div>
                <div>
                    <div id="compose-name" style="font-weight: bold; margin-top: 5px;">User</div>
                    <div style="font-size: 0.8rem; color: #888; background: #222; width: fit-content; padding: 2px 8px; border-radius: 10px; margin-top: 2px;">عام</div>
                </div>
            </div>
            <textarea id="reese-text-input" class="compose-textarea" placeholder="بماذا تفكر؟" oninput="this.style.height='auto';this.style.height=(this.scrollHeight)+'px';"></textarea>
            
            <div id="ai-reese-suggestions" class="ai-suggestions-container hidden"></div>

            <div id="reese-media-preview" class="compose-media-preview hidden"></div>
            <button class="ai-suggestion-btn" onclick="generateAiReese()">
                <i class="fas fa-wand-magic-sparkles"></i> اقتراح AI
            </button>
            <div style="margin-top: auto; display: flex; align-items: center; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <label class="add-media-btn" title="إضافة صور">
                    <i class="fas fa-camera-retro"></i>
                    <input type="file" id="reese-img-input" multiple accept="image/*" hidden onchange="handleReeseImageSelect(this)">
                </label>
                <button onclick="publishReese()" class="glossy-black-btn" style="width: auto; min-width: 100px;">
                    نشر <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="menu-modal" class="full-screen-overlay">
        <button class="shiny-back-btn" onclick="toggleMenu()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <div class="overlay-content">
            <div style="text-align: center; margin-bottom: 15px;">
                <div class="avatar-frame" id="menu-avatar" style="width: 100px; height: 100px; font-size: 3rem; border-width: 3px;"></div>
                <h3 id="menu-username" style="margin: 15px 0 5px; font-size: 1.3rem;">User</h3>
                <span id="menu-role" style="font-size: 0.85rem; background: #333; padding: 4px 15px; border-radius: 20px; color: #aaa;">Role</span>
            </div>

            <div id="menu-edit-section" class="hidden" style="background: #222; padding: 15px; border-radius: 15px;">
                <label style="color: #888; font-size: 0.8rem;">تعديل الاسم:</label>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <input type="text" id="edit-name-input" class="smart-input" style="margin: 0; padding: 10px;">
                    <button onclick="saveProfileName()" class="modern-btn" style="width: auto; padding: 0 20px; font-size: 0.9rem;">حفظ</button>
                </div>
            </div>
            <div id="menu-avatar-section" class="hidden">
                <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 10px;">اختر شكلاً جديداً:</p>
                <div class="avatar-grid">
                    <div class="avatar-option" onclick="saveAvatar('fa-user-astronaut')"><i class="fas fa-user-astronaut"></i></div>
                    <div class="avatar-option" onclick="saveAvatar('fa-user-tie')"><i class="fas fa-user-tie"></i></div>
                    <div class="avatar-option" onclick="saveAvatar('fa-user-graduate')"><i class="fas fa-user-graduate"></i></div>
                    <div class="avatar-option" onclick="saveAvatar('fa-user-ninja')"><i class="fas fa-user-ninja"></i></div>
                    <div class="avatar-option" onclick="saveAvatar('fa-robot')"><i class="fas fa-robot"></i></div>
                    <div class="avatar-option" onclick="saveAvatar('fa-cat')"><i class="fas fa-cat"></i></div>
                    <div class="avatar-option" onclick="saveAvatar('fa-dragon')"><i class="fas fa-dragon"></i></div>
                    <div class="avatar-option" onclick="saveAvatar('fa-user-secret')"><i class="fas fa-user-secret"></i></div>
                </div>
            </div>
            <div class="menu-item" onclick="toggleEditProfile()">
                <i class="fas fa-user-edit" style="color: var(--accent-primary); font-size: 1.2rem;"></i>
                <span style="font-size: 1rem;">تعديل الملف الشخصي</span>
            </div>
            <div class="menu-item" onclick="toggleAvatarSelect()">
                <i class="fas fa-theater-masks" style="color: #d946ef; font-size: 1.2rem;"></i>
                <span style="font-size: 1rem;">تغيير الأفاتار</span>
            </div>
            <div class="menu-item" onclick="shareApp()">
                <i class="fas fa-share-alt" style="color: var(--success); font-size: 1.2rem;"></i>
                <span style="font-size: 1rem;">مشاركة المنصة</span>
            </div>
            <div style="margin-top: auto;">
                 <button class="glossy-black-btn danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
        </div>
    </div>

    <!-- Profile & Link Modal -->
    <div id="profile-info-modal" class="hidden">
        <div class="bottom-sheet-content">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                 <h3 style="margin:0;">الملف الشخصي</h3>
                 <button onclick="document.getElementById('profile-info-modal').classList.add('hidden')" style="background:none; border:none; color:#fff;"><i class="fas fa-times fa-lg"></i></button>
             </div>
             <div style="text-align:center; margin-bottom:20px;">
                 <div class="avatar-frame" id="pi-avatar" style="width:80px; height:80px; margin:0 auto 10px;"></div>
                 <h3 id="pi-name"></h3>
                 <div id="pi-id-box" class="copy-box" onclick="copyToClipboard(this.innerText)"></div>
                 <button class="modern-btn" onclick="copyProfileLink()" style="margin-top:15px; width:100%;"><i class="fas fa-link"></i> نسخ رابط المحادثة</button>
             </div>
        </div>
    </div>

    <!-- User Search Modal -->
    <div id="user-search-modal" class="hidden">
        <div class="bottom-sheet-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin:0; text-align:center;">بحث عن مستخدم</h3>
                <button onclick="document.getElementById('user-search-modal').classList.add('hidden')" style="background: rgba(255, 255, 255, 0.1); border: none; color: #fff; padding: 5px 12px; border-radius: 12px; font-size: 0.9rem; cursor: pointer;">خروج <i class="fas fa-times"></i></button>
            </div>
            
            <div class="chat-search-bar" style="margin-bottom:20px;">
                <input type="text" id="user-search-id-input" placeholder="أدخل معرف المستخدم (ID)...">
                <!-- NEW ELECTRIC BUTTON -->
                <button onclick="searchUserById()" class="magic-search-btn" title="بحث سريع">
                    <i class="fas fa-bolt"></i>
                </button>
            </div>
            <div id="user-search-result"></div>
        </div>
    </div>

    <div id="ai-gen-modal" class="full-screen-overlay">
        <button class="shiny-back-btn" onclick="toggleAiGenerator()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <div class="overlay-content">
            <div style="text-align: center; margin-bottom: 20px; padding: 30px 0;">
                <i class="fas fa-brain" style="font-size: 4rem; color: #d946ef; margin-bottom: 20px; text-shadow: 0 0 30px rgba(217, 70, 239, 0.4);"></i>
                <h2 style="margin: 0;">SA EDU AI</h2>
                <p style="color: #888;">حدد التفاصيل وسأقوم ببناء الاختبار لك</p>
            </div>
            <textarea id="ai-gen-text" class="smart-input" rows="4" placeholder="اكتب الموضوع هنا (مثال: الحرب العالمية الثانية، قوانين نيوتن...)" style="background: #111; border-color: #333;"></textarea>
            <label class="smart-input" style="display: flex; align-items: center; gap: 10px; cursor: pointer; background: #111; border-color: #333;">
                <i class="fas fa-image" style="color: var(--accent-primary);"></i> <span>رفع صورة للمنهج لتحليلها</span>
                <input type="file" id="ai-gen-img" hidden accept="image/*" onchange="previewAiGenImg(this)">
            </label>
            <div id="ai-gen-preview" class="hidden" style="margin-bottom: 15px; text-align: center;"><img src="" style="height: 100px; border-radius: 12px; border: 1px solid #333;"></div >
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label style="color:#aaa; font-size:0.8rem; display:block; margin-bottom:5px;">عدد الاختياري (MCQ)</label>
                    <input type="number" id="ai-mcq-count" class="smart-input" value="5" style="text-align: center; margin: 0;">
                </div>
                <div style="flex: 1;">
                    <label style="color:#aaa; font-size:0.8rem; display:block; margin-bottom:5px;">عدد المقالي</label>
                    <input type="number" id="ai-essay-count" class="smart-input" value="0" style="text-align: center; margin: 0;">
                </div>
            </div>

            <div style="margin-top: auto;">
                <button onclick="generateAiQuestions()" class="glossy-black-btn">
                    <i class="fas fa-magic"></i> توليد الاختبار الآن
                </button>
            </div>
        </div>
    </div>

    <div id="phone-modal" class="hidden">
        <div class="bottom-sheet-content" style="background: #111; height: auto; text-align:center;">
            <i class="fas fa-mobile-alt" style="font-size: 3rem; color: var(--accent-primary); margin-bottom: 15px;"></i>
            <h3>مطلوب رقم للتواصل</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">يرجى إدخال رقم هاتف ولي الأمر أو رقمك الشخصي لحفظ النتائج.</p>
            <input type="tel" id="student-phone-input" class="smart-input" placeholder="01xxxxxxxxx" style="text-align:center; font-size:1.1rem; letter-spacing:2px;">
            <button onclick="savePhoneAndStart()" class="modern-btn" style="margin-top:15px;">حفظ وبدء الاختبار</button>
        </div>
    </div>

    <div id="teacher-detail-modal" class="hidden">
        <div class="bottom-sheet-content" style="background: #111; max-height: 90vh;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                 <h3 style="margin:0;">تفاصيل الطالب</h3>
                 <button onclick="document.getElementById('teacher-detail-modal').classList.add('hidden')" style="background:none; border:none; color:#fff;"><i class="fas fa-times fa-lg"></i></button>
             </div>
             <div style="text-align:center; background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin-bottom:20px;">
                 <div id="td-name" style="font-weight:bold; font-size:1.2rem;"></div>
                 <div id="td-phone" style="color:var(--accent-gold); font-size:1.1rem; margin-top:5px; font-family:monospace;"></div>
             </div>
             <h4 style="color:#888;">سجل الإجابات:</h4>
             <div id="td-answers-list" style="max-height: 50vh; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="sa-custom-alert" class="">
        <div class="sa-alert-box">
            <div id="sa-alert-icon" class="sa-alert-icon"></div>
            <div id="sa-alert-title" class="sa-alert-title"></div>
            <div id="sa-alert-msg" class="sa-alert-msg"></div>
            <div id="sa-alert-actions" class="sa-alert-actions"></div>
        </div>
    </div>

    <div id="pwa-install-banner" class="hidden">
        <div class="pwa-content">
            <img src="https://i.postimg.cc/BQQb5YDn/MOWU-DESIGN.png" alt="SA EDU App" class="pwa-icon">
            <div class="pwa-info">
                <h4>تثبيت SA EDU</h4>
                <p>تجربة أفضل وأسرع</p>
            </div>
        </div>
        <div class="pwa-actions">
            <button class="pwa-btn close" onclick="closePWA()">إغلاق</button>
            <button class="pwa-btn install" onclick="installPWA()">تثبيت</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let selectedRole = 'student'; 
        let currentUser = null;
        let currentQuestions = [];
        let currentImgBase64 = null;
        let aiGenImgBase64 = null;
        let currentChatId = null;
        let currentChatMessages = [];
        let isIncognito = false;
        let isEditingMode = false;
        let editingTestId = null;
        let isMyPostsView = false;
        let reeseImages = []; 
        let myUid = null;
        let activeChatRoomId = null;

        let lastScrollTop = 0;
        window.addEventListener("scroll", function() {
            let st = window.pageYOffset || document.documentElement.scrollTop;
            if (st > lastScrollTop && st > 10){
                document.querySelector('.top-nav').classList.add('nav-hidden');
            } else {
                document.querySelector('.top-nav').classList.remove('nav-hidden');
            }
            lastScrollTop = st <= 0 ? 0 : st;
        }, false);

        // Handle clicking outside modals to close them
        window.addEventListener('click', function(e) {
            const searchModal = document.getElementById('user-search-modal');
            const profileModal = document.getElementById('profile-info-modal');
            const teacherDetailModal = document.getElementById('teacher-detail-modal');
            const phoneModal = document.getElementById('phone-modal');

            // Check if the click target IS the modal container (which is the dark overlay)
            if (e.target === searchModal) {
                searchModal.classList.add('hidden');
            }
            if (e.target === profileModal) {
                profileModal.classList.add('hidden');
            }
            if (e.target === teacherDetailModal) {
                teacherDetailModal.classList.add('hidden');
            }
            // Phone modal is usually mandatory, so we might not want to close it by clicking outside, 
            // but if needed:
            // if (e.target === phoneModal) phoneModal.classList.add('hidden');
        });

        function toggleConstructionOverlay(show, title="SA AI Building...", sub="جاري المعالجة") {
            const ol = document.getElementById('construction-overlay');
            if (show) {
                ol.querySelector('.construction-text').innerText = title;
                ol.querySelector('.construction-sub').innerText = sub;
                ol.classList.add('active');
            } else {
                ol.classList.remove('active');
            }
        }

        function getSkeletonHTML() {
            return `
            <div class="skeleton-loader">
                <div class="skeleton-header">
                    <div class="skeleton-circle"></div>
                    <div class="skeleton-text">
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line" style="width:30%"></div>
                    </div>
                </div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-rect"></div>
            </div>`;
        }
        function getMultipleSkeletons(count = 3) {
            let html = ''; for(let i=0; i<count; i++) html += getSkeletonHTML(); return html;
        }

        function getEmptyStateHTML(type) {
            if(type === 'posts') {
                return `<div class="empty-state-container"><div class="empty-avatar"><i class="fas fa-box-open" style="color:#666;"></i></div><h3 style="color:#888;">لا توجد منشورات حالياً</h3><p style="color:#555; font-size:0.9rem;">كن أول من يشارك أفكاره!</p></div>`;
            } else if (type === 'exams') {
                return `<div class="empty-state-container"><div class="empty-avatar"><i class="fas fa-folder-open" style="color:#666;"></i></div><h3 style="color:#888;">لا توجد اختبارات</h3><p style="color:#555; font-size:0.9rem;">استمتع بوقتك، لا يوجد ضغط الآن.</p></div>`;
            } else if (type === 'chats') {
                return `<div class="empty-state-container"><div class="empty-avatar"><i class="fab fa-telegram-plane" style="color:#666;"></i></div><h3 style="color:#888;">لا توجد محادثات</h3><p style="color:#555; font-size:0.9rem;">ابحث عن أصدقاء لبدء الدردشة.</p></div>`;
            }
            return '';
        }

        window.saAlert = (msg, type = 'info', title = null) => {
            const modal = document.getElementById('sa-custom-alert');
            const iconDiv = document.getElementById('sa-alert-icon');
            const titleDiv = document.getElementById('sa-alert-title');
            const msgDiv = document.getElementById('sa-alert-msg');
            const actionsDiv = document.getElementById('sa-alert-actions');
            actionsDiv.innerHTML = `<button class="sa-btn sa-btn-primary" onclick="closeSaAlert()">حسناً</button>`;
            let iconHtml = ''; let color = '#fff';
            if(type === 'success') { iconHtml = '<i class="fas fa-check-circle"></i>'; color = 'var(--success)'; if(!title) title = 'نجاح'; } 
            else if (type === 'error') { iconHtml = '<i class="fas fa-times-circle"></i>'; color = 'var(--danger)'; if(!title) title = 'خطأ'; } 
            else { iconHtml = '<i class="fas fa-info-circle"></i>'; color = 'var(--accent-primary)'; if(!title) title = 'تنبيه'; }
            iconDiv.innerHTML = iconHtml; iconDiv.style.color = color;
            titleDiv.innerText = title; msgDiv.innerText = msg;
            modal.classList.add('active');
        };

        window.saConfirm = (msg, onConfirm) => {
            const modal = document.getElementById('sa-custom-alert');
            document.getElementById('sa-alert-icon').innerHTML = '<i class="fas fa-question-circle" style="color:var(--warning)"></i>';
            document.getElementById('sa-alert-title').innerText = 'تأكيد';
            document.getElementById('sa-alert-msg').innerText = msg;
            const actionsDiv = document.getElementById('sa-alert-actions');
            actionsDiv.innerHTML = '';
            const btnYes = document.createElement('button');
            btnYes.className = 'sa-btn sa-btn-primary'; btnYes.innerText = 'نعم، متابعة'; btnYes.style.background = 'var(--warning)';
            btnYes.onclick = () => { closeSaAlert(); onConfirm(); };
            const btnNo = document.createElement('button');
            btnNo.className = 'sa-btn sa-btn-secondary'; btnNo.innerText = 'إلغاء';
            btnNo.onclick = closeSaAlert;
            actionsDiv.appendChild(btnNo); actionsDiv.appendChild(btnYes);
            modal.classList.add('active');
        };

        window.closeSaAlert = () => { document.getElementById('sa-custom-alert').classList.remove('active'); };

        function createAdBanner() {
            const container = document.createElement('div'); container.className = 'ad-banner';
            const iframe = document.createElement('iframe');
            iframe.style.width = '468px'; iframe.style.height = '60px'; iframe.style.border = 'none';
            iframe.style.overflow = 'hidden'; iframe.style.maxWidth = '100%'; 
            const adContent = `<html><body style="margin:0;padding:0;background:transparent;display:flex;justify-content:center;align-items:center;"><script async>atOptions={'key':'e0f63746bfceb42ce1134aaff1b6709d','format':'iframe','height':60,'width':468,'params':{}};<\/script><script async src="https://www.highperformanceformat.com/e0f63746bfceb42ce1134aaff1b6709d/invoke.js"><\/script></body></html>`;
            container.appendChild(iframe);
            setTimeout(() => { 
                const doc = iframe.contentWindow.document; 
                doc.open(); doc.write(adContent); doc.close(); 
            }, 50);
            return container;
        }

        const getBase64 = (file) => new Promise((resolve) => {
            const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result);
        });

        async function recognizeImageText(imageBase64) {
            try {
                const worker = Tesseract.createWorker({ logger: m => {} });
                await worker.load();
                await worker.loadLanguage('ara+eng');
                await worker.initialize('ara+eng');
                const { data: { text } } = await worker.recognize(imageBase64);
                await worker.terminate();
                return text;
            } catch (error) {
                console.error("OCR Error:", error);
                throw new Error("فشل في قراءة النص من الصورة.");
            }
        }

        async function callPollinationsAI(prompt) {
            const url = `https://text.pollinations.ai/${encodeURIComponent(prompt)}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('API Error');
                return await response.text();
            } catch (error) {
                console.error("AI Error:", error);
                throw error;
            }
        }

        window.goToAuth = () => {
                document.getElementById('landing-layer').classList.add('hidden');
                document.getElementById('auth-layer').classList.remove('hidden');
                setAuthRole('student');
        };

        window.setAuthRole = (role) => {
            selectedRole = role;
            const icon = role === 'student' ? 'fa-user-astronaut' : 'fa-user-tie';
            const color = role === 'student' ? 'var(--accent-primary)' : 'var(--accent-gold)';
            document.getElementById('btn-role-student').classList.toggle('active', role === 'student');
            document.getElementById('btn-role-teacher').classList.toggle('active', role === 'teacher');
            const display = document.getElementById('auth-avatar-display');
            display.innerHTML = `<i class="fas ${icon}"></i>`;
            display.style.color = color; display.style.borderColor = color;
            display.className = `avatar-frame avatar-${role}`;
        };

        window.backToLanding = () => {
            document.getElementById('auth-layer').classList.add('hidden');
            document.getElementById('landing-layer').classList.remove('hidden');
        };

        window.handleSmartAuth = async () => {
            const name1 = document.getElementById('auth-name-1').value.trim();
            const name2 = document.getElementById('auth-name-2').value.trim();
            const name3 = document.getElementById('auth-name-3').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const status = document.getElementById('auth-status');
            if (!name1 || !name2 || !name3 || !pass) return status.innerText = "يرجى ملء جميع الحقول";
            const passRegex = /^[a-zA-Z0-9]+$/;
            if (pass.length !== 6 || !passRegex.test(pass)) return status.innerText = "كلمة المرور يجب أن تكون 6 خانات (حروف إنجليزية وأرقام فقط)";
            const fullName = `${name1} ${name2} ${name3}`;
            status.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> جارِ الاتصال...';
            const userRef = ref(db, `users/${selectedRole}s/${fullName}`);
            try {
                const snap = await get(userRef);
                if (snap.exists()) {
                    if (snap.val().password === pass) {
                        const savedIcon = snap.val().icon;
                        let uid = snap.val().uid;
                        if(!uid) {
                            uid = generateUID();
                            await update(userRef, { uid: uid });
                        }
                        loginSuccess(fullName, savedIcon, uid);
                    } else status.innerText = "كلمة المرور غير صحيحة";
                } else {
                    const defaultIcon = selectedRole === 'student' ? 'fa-user-astronaut' : 'fa-user-tie';
                    const uid = generateUID();
                    await set(userRef, { password: pass, joined: Date.now(), icon: defaultIcon, uid: uid });
                    loginSuccess(fullName, defaultIcon, uid);
                }
            } catch (e) { console.error(e); status.innerText = "حدث خطأ في الاتصال"; }
        };

        function generateUID() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function loginSuccess(name, icon, uid) {
            currentUser = name;
            myUid = uid;
            localStorage.setItem('sa_user', name);
            localStorage.setItem('sa_role', selectedRole);
            localStorage.setItem('sa_icon', icon || (selectedRole === 'student' ? 'fa-user-astronaut' : 'fa-user-tie'));
            localStorage.setItem('sa_uid', uid);
            
            document.getElementById('landing-layer').classList.add('hidden');
            document.getElementById('auth-layer').classList.add('hidden');
            updateMenuInfo();
            
            // Handle Deep Links
            handleDeepLinks();

            if (selectedRole === 'teacher') {
                document.getElementById('teacher-app').classList.remove('hidden');
                initTeacherApp();
            } else {
                document.getElementById('student-app').classList.remove('hidden');
                loadStudentExams(); loadStudentGrades(); initStudentReese(); 
            }
            initDardasha();
        }

        function handleDeepLinks() {
            const params = new URLSearchParams(window.location.search);
            const shareId = params.get('shareId');
            const examId = params.get('examId');
            const postId = params.get('postId');
            const chatTarget = params.get('chat');

            // AI Chat Share
            if(shareId) { 
                const prefix = selectedRole === 'teacher' ? 't' : 's';
                switchTab(`${prefix}-ai`); loadSharedChat(shareId, prefix); 
            }
            
            // Exam Share
            if(examId) {
                if(selectedRole === 'student') {
                    switchTab('s-exams');
                    checkPhoneAndStart(examId);
                } else {
                    // Teacher viewing shared exam (maybe for editing or checking)
                    switchTab('t-library');
                    saAlert("هذا رابط امتحان. كمعلم يمكنك تعديله من المكتبة.", "info");
                }
            }

            // Post Share
            if(postId) {
                const prefix = selectedRole === 'teacher' ? 't' : 's';
                switchTab(`${prefix}-reese`);
                // Highlight post logic could go here, for now just load feed
                setTimeout(() => {
                    const el = document.getElementById(`post-${postId}`);
                    if(el) { el.scrollIntoView({behavior: "smooth"}); el.style.border = "2px solid var(--accent-primary)"; }
                }, 1500);
            }

            // Chat with User
            if(chatTarget && chatTarget !== myUid) {
                const prefix = selectedRole === 'teacher' ? 't' : 's';
                switchTab(`${prefix}-dardasha`);
                searchUserById(chatTarget);
            }
        }

        window.toggleMenu = () => {
            document.getElementById('menu-modal').classList.toggle('open');
            document.getElementById('menu-edit-section').classList.add('hidden');
            document.getElementById('menu-avatar-section').classList.add('hidden');
        };

        function updateMenuInfo() {
            document.getElementById('menu-username').innerText = currentUser;
            document.getElementById('menu-role').innerText = selectedRole === 'teacher' ? 'معلم' : 'طالب';
            const iconClass = localStorage.getItem('sa_icon');
            const color = selectedRole === 'teacher' ? 'var(--accent-gold)' : 'var(--accent-primary)';
            document.getElementById('menu-avatar').innerHTML = `<i class="fas ${iconClass}"></i>`;
            document.getElementById('menu-avatar').style.color = color;
            document.getElementById('menu-avatar').style.borderColor = color;
            document.getElementById('edit-name-input').value = currentUser;
            const reeseAvs = document.querySelectorAll('.reese-avatar-mini');
            reeseAvs.forEach(el => { el.innerHTML = `<i class="fas ${iconClass}" style="color:${color}"></i>`; });
            
            // Update Profile Modal info
            document.getElementById('pi-name').innerText = currentUser;
            document.getElementById('pi-avatar').innerHTML = `<i class="fas ${iconClass}"></i>`;
            document.getElementById('pi-avatar').style.color = color;
            document.getElementById('pi-avatar').style.borderColor = color;
            document.getElementById('pi-id-box').innerText = myUid;
            
            // Update Chat sidebar Avatar
            const prefix = selectedRole === 'teacher' ? 't' : 's';
            const chatAv = document.getElementById(`${prefix}-chat-my-avatar`);
            if(chatAv) {
                chatAv.innerHTML = `<i class="fas ${iconClass}"></i>`;
                chatAv.style.color = color;
                chatAv.style.borderColor = color;
            }
        }

        window.toggleEditProfile = () => {
            document.getElementById('menu-edit-section').classList.toggle('hidden');
            document.getElementById('menu-avatar-section').classList.add('hidden');
        };

        window.saveProfileName = async () => {
            const newName = document.getElementById('edit-name-input').value.trim();
            if(!newName || newName === currentUser) return;
            saConfirm("تغيير الاسم سيؤدي لإنشاء حساب جديد. هل أنت متأكد؟", async () => {
                const oldRef = ref(db, `users/${selectedRole}s/${currentUser}`);
                const snapshot = await get(oldRef);
                const data = snapshot.val();
                await set(ref(db, `users/${selectedRole}s/${newName}`), data);
                await remove(oldRef);
                currentUser = newName; localStorage.setItem('sa_user', newName);
                updateMenuInfo(); saAlert("تم تغيير الاسم بنجاح", "success"); toggleEditProfile();
            });
        };

        window.toggleAvatarSelect = () => {
            document.getElementById('menu-avatar-section').classList.toggle('hidden');
            document.getElementById('menu-edit-section').classList.add('hidden');
        };

        window.saveAvatar = async (iconClass) => {
            localStorage.setItem('sa_icon', iconClass);
            await update(ref(db, `users/${selectedRole}s/${currentUser}`), { icon: iconClass });
            updateMenuInfo(); toggleAvatarSelect();
        };

        window.logout = () => { localStorage.clear(); location.reload(); };

        window.shareApp = () => {
            const url = window.location.href.split('?')[0]; 
            const text = "انضم لمنصة SA EDU التعليمية المتطورة!";
            if (navigator.share) navigator.share({ title: 'SA EDU', text: text, url: url }).catch(err => console.log(err));
            else { navigator.clipboard.writeText(url).then(() => saAlert("تم نسخ رابط المنصة!", "success")); }
        };

        function initTeacherApp() {
            loadTeacherTests(); renderOptionFields(); startNewChat('t'); loadReesePosts('t');
            startTypewriter("cta-type-text", "اضغط هنا لكتابة الامتحان");
        }
        function initStudentReese() { loadReesePosts('s'); }

        function startTypewriter(elementId, text) {
            const el = document.getElementById(elementId);
            if(!el) return;
            el.innerHTML = ""; let i = 0;
            function type() { if (i < text.length) { el.innerHTML += text.charAt(i); i++; setTimeout(type, 80); } }
            type();
        }
        if(document.getElementById('landing-type-text')) { startTypewriter("landing-type-text", "منصة تعليمية ذكية تنقلك إلى آفاق المستقبل"); }

        window.switchTab = (tabId, btn) => {
            const portal = selectedRole === 'teacher' ? 'teacher-app' : 'student-app';
            document.querySelectorAll(`#${portal} .app-section`).forEach(s => s.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            if(btn) { document.querySelectorAll(`#${portal} .nav-btn`).forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            
            if(tabId === 's-grades') loadStudentGrades();
            if(tabId === 's-exams') {
                loadStudentExams();
                startTypewriter("student-type-text", "الاختبارات المتاحة لتطويرك");
            }
            if(tabId === 't-library') {
                loadTeacherTests();
                startTypewriter("cta-type-text", "اضغط هنا لكتابة الامتحان");
            }
            if(tabId === 't-reese' || tabId === 's-reese') {
                const prefix = selectedRole === 'teacher' ? 't' : 's';
                loadReesePosts(prefix);
            }
            if(tabId === 't-ai' && !currentChatId) startNewChat('t');
            if(tabId === 's-ai' && !currentChatId) startNewChat('s');
        };

        // --- Dardasha Logic ---

        function initDardasha() {
            const prefix = selectedRole === 'teacher' ? 't' : 's';
            const list = document.getElementById(`${prefix}-chat-list`);
            list.innerHTML = getMultipleSkeletons(2);
            
            // Listen for my chats
            onValue(ref(db, `user_chats/${myUid}`), (snap) => {
                list.innerHTML = '';
                if(!snap.exists()) {
                    list.innerHTML = getEmptyStateHTML('chats');
                    return;
                }
                
                const chats = snap.val();
                Object.entries(chats).forEach(([chatId, chatInfo]) => {
                    const el = document.createElement('div');
                    el.className = 'chat-item';
                    el.onclick = () => openChatRoom(chatId, chatInfo.otherName, chatInfo.otherIcon, chatInfo.otherUid);
                    el.innerHTML = `
                        <div class="avatar-frame mini-frame" style="border-color: #666; color: #ccc;"><i class="fas ${chatInfo.otherIcon}"></i></div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:#fff; display:flex; justify-content:space-between;">
                                <span>${chatInfo.otherName}</span>
                                <span style="font-size:0.7rem; color:#666;">${chatInfo.lastMsgTime ? new Date(chatInfo.lastMsgTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</span>
                            </div>
                            <div style="font-size:0.8rem; color:#aaa; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                                ${chatInfo.lastMsg ? (chatInfo.lastMsg.includes('data:image') ? '📷 صورة' : chatInfo.lastMsg) : 'ابدأ المحادثة...'}
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                });
            });
        }

        window.openMyProfileModal = () => {
            document.getElementById('profile-info-modal').classList.remove('hidden');
        };

        window.copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => saAlert("تم النسخ: " + text, "success"));
        };

        window.copyProfileLink = () => {
            const url = `${window.location.href.split('?')[0]}?chat=${myUid}`;
            navigator.clipboard.writeText(url).then(() => saAlert("تم نسخ رابط المحادثة المباشر!", "success"));
        };

        window.toggleUserSearchModal = () => {
            document.getElementById('user-search-modal').classList.remove('hidden');
            document.getElementById('user-search-result').innerHTML = '';
            document.getElementById('user-search-id-input').value = '';
        };

        window.searchUserById = async (forcedId = null) => {
            const id = forcedId || document.getElementById('user-search-id-input').value.trim();
            if(!id) return;
            
            const resultDiv = document.getElementById('user-search-result');
            if(!forcedId) resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري البحث...';
            
            // Search in both students and teachers
            let foundUser = null;
            let foundRole = '';
            
            // Try students
            const sSnap = await get(ref(db, `users/students`));
            if(sSnap.exists()) {
                Object.entries(sSnap.val()).forEach(([name, data]) => {
                    if(data.uid == id) { foundUser = {name, ...data}; foundRole = 'student'; }
                });
            }
            
            if(!foundUser) {
                const tSnap = await get(ref(db, `users/teachers`));
                if(tSnap.exists()) {
                    Object.entries(tSnap.val()).forEach(([name, data]) => {
                        if(data.uid == id) { foundUser = {name, ...data}; foundRole = 'teacher'; }
                    });
                }
            }
            
            if(foundUser) {
                if(forcedId) {
                    // Directly open chat if deep link
                    document.getElementById('user-search-modal').classList.add('hidden');
                    startChatWithUser(foundUser.name, foundUser.icon, foundUser.uid);
                    return;
                }

                const roleColor = foundRole === 'teacher' ? 'var(--accent-gold)' : 'var(--accent-primary)';
                resultDiv.innerHTML = `
                    <div style="background:#222; padding:15px; border-radius:15px; text-align:center; margin-top:15px;">
                        <div class="avatar-frame mini-frame" style="margin:0 auto 10px; color:${roleColor}; border-color:${roleColor};">
                            <i class="fas ${foundUser.icon}"></i>
                        </div>
                        <h4 style="margin:0 0 10px;">${foundUser.name}</h4>
                        <button class="modern-btn" onclick="startChatWithUser('${foundUser.name}', '${foundUser.icon}', '${foundUser.uid}')">بدء المحادثة</button>
                    </div>
                `;
            } else {
                if(!forcedId) resultDiv.innerHTML = '<p style="color:var(--danger); text-align:center;">المستخدم غير موجود</p>';
            }
        };

        window.startChatWithUser = async (otherName, otherIcon, otherUid) => {
            document.getElementById('user-search-modal').classList.add('hidden');
            // Create consistent Chat ID (smaller UID first)
            const chatId = myUid < otherUid ? `${myUid}_${otherUid}` : `${otherUid}_${myUid}`;
            
            // Update User Chats List for both
            const myUpdate = { otherName, otherIcon, otherUid, lastMsg: '', lastMsgTime: Date.now() };
            const otherUpdate = { otherName: currentUser, otherIcon: localStorage.getItem('sa_icon'), otherUid: myUid, lastMsg: '', lastMsgTime: Date.now() };
            
            await update(ref(db, `user_chats/${myUid}/${chatId}`), myUpdate);
            await update(ref(db, `user_chats/${otherUid}/${chatId}`), otherUpdate);
            
            openChatRoom(chatId, otherName, otherIcon, otherUid);
        };

        window.openChatRoom = (chatId, name, icon, uid) => {
            activeChatRoomId = chatId;
            const prefix = selectedRole === 'teacher' ? 't' : 's';
            const win = document.getElementById(`${prefix}-chat-window`);
            
            // Hide sidebar on mobile
            if(window.innerWidth < 768) {
                document.getElementById(`${prefix}-chat-sidebar`).classList.add('hidden');
            }
            win.classList.remove('hidden');
            
            win.innerHTML = `
                <div class="chat-header">
                    <button class="icon-btn-small" onclick="closeChatWindow('${prefix}')"><i class="fas fa-arrow-right"></i></button>
                    <div class="avatar-frame mini-frame" style="width:35px; height:35px; font-size:1rem;"><i class="fas ${icon}"></i></div>
                    <div style="font-weight:bold;">${name}</div>
                    <div style="margin-right:auto; display:flex; gap:10px;">
                        <button class="icon-btn-small" title="اتصال صوتي (قريباً)"><i class="fas fa-phone"></i></button>
                        <button class="icon-btn-small" onclick="copyProfileLinkFor('${uid}')" title="نسخ رابط المستخدم"><i class="fas fa-link"></i></button>
                    </div>
                </div>
                <div class="chat-msgs-area" id="chat-msgs-${chatId}"></div>
                <div class="chat-input-area">
                    <label class="icon-btn-small" style="cursor:pointer;"><i class="fas fa-camera"></i><input type="file" hidden accept="image/*" onchange="sendChatImage(this, '${chatId}', '${uid}')"></label>
                    <input type="text" id="chat-input-${chatId}" placeholder="اكتب رسالة..." onkeypress="handleChatEnter(event, '${chatId}', '${uid}')">
                    <button class="send-btn" style="width:35px; height:35px;" onclick="sendChatMessage('${chatId}', '${uid}')"><i class="fas fa-paper-plane"></i></button>
                </div>
            `;

            // Listen for messages
            const msgContainer = document.getElementById(`chat-msgs-${chatId}`);
            onValue(ref(db, `chats/${chatId}`), (snap) => {
                msgContainer.innerHTML = '';
                if(snap.exists()) {
                    const msgs = snap.val();
                    Object.values(msgs).forEach(msg => {
                        const isMe = msg.sender === myUid;
                        const div = document.createElement('div');
                        div.className = `msg-bubble ${isMe ? 'sent' : 'recv'}`;
                        
                        let content = msg.text;
                        if(msg.type === 'image') {
                            content = `<img src="${msg.text}" class="whatsapp-img" onclick="openImageViewer(this.src)">`;
                        }
                        
                        div.innerHTML = `
                            ${content}
                            <div class="msg-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                        `;
                        msgContainer.appendChild(div);
                    });
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }
            });
        };

        window.closeChatWindow = (prefix) => {
            document.getElementById(`${prefix}-chat-window`).classList.add('hidden');
            document.getElementById(`${prefix}-chat-sidebar`).classList.remove('hidden');
            activeChatRoomId = null;
        };

        window.handleChatEnter = (e, chatId, otherUid) => {
            if(e.key === 'Enter') sendChatMessage(chatId, otherUid);
        };

        window.sendChatMessage = async (chatId, otherUid) => {
            const input = document.getElementById(`chat-input-${chatId}`);
            const text = input.value.trim();
            if(!text) return;
            
            await push(ref(db, `chats/${chatId}`), {
                sender: myUid,
                text: text,
                type: 'text',
                timestamp: Date.now()
            });
            
            // Update last msg
            await update(ref(db, `user_chats/${myUid}/${chatId}`), { lastMsg: text, lastMsgTime: Date.now() });
            await update(ref(db, `user_chats/${otherUid}/${chatId}`), { lastMsg: text, lastMsgTime: Date.now() });
            
            input.value = '';
        };

        window.sendChatImage = async (input, chatId, otherUid) => {
            if(input.files && input.files[0]) {
                // Check Limit (5 per day)
                const today = new Date().toDateString();
                const usageKey = `img_usage_${myUid}_${today}`;
                let count = parseInt(localStorage.getItem(usageKey) || '0');
                
                if(count >= 5) {
                    saAlert("عفواً، لقد تجاوزت الحد الأقصى لإرسال الصور اليوم (5 صور).", "error");
                    input.value = '';
                    return;
                }
                
                const b64 = await getBase64(input.files[0]);
                
                await push(ref(db, `chats/${chatId}`), {
                    sender: myUid,
                    text: b64,
                    type: 'image',
                    timestamp: Date.now()
                });
                
                count++;
                localStorage.setItem(usageKey, count);
                
                await update(ref(db, `user_chats/${myUid}/${chatId}`), { lastMsg: '📷 صورة', lastMsgTime: Date.now() });
                await update(ref(db, `user_chats/${otherUid}/${chatId}`), { lastMsg: '📷 صورة', lastMsgTime: Date.now() });
                
                input.value = '';
            }
        };

        window.copyProfileLinkFor = (uid) => {
            const url = `${window.location.href.split('?')[0]}?chat=${uid}`;
            navigator.clipboard.writeText(url).then(() => saAlert("تم نسخ رابط المستخدم!", "success"));
        };

        window.filterChats = (prefix, term) => {
            const items = document.querySelectorAll(`#${prefix}-chat-list .chat-item`);
            items.forEach(item => {
                const name = item.querySelector('div[style*="font-weight:bold"]').innerText.toLowerCase();
                if(name.includes(term.toLowerCase())) item.classList.remove('hidden');
                else item.classList.add('hidden');
            });
        };

        // --- End Dardasha Logic ---

        window.openReeseCompose = () => {
            document.getElementById('reese-compose-modal').classList.add('open');
            const icon = localStorage.getItem('sa_icon');
            const color = selectedRole === 'teacher' ? 'var(--accent-gold)' : 'var(--accent-primary)';
            const frame = document.getElementById('compose-avatar');
            frame.innerHTML = `<i class="fas ${icon}"></i>`;
            frame.style.color = color; frame.style.borderColor = color;
            document.getElementById('compose-name').innerText = currentUser;
            reeseImages = []; renderReeseMediaPreview();
            
            document.getElementById('ai-reese-suggestions').innerHTML = '';
            document.getElementById('ai-reese-suggestions').classList.add('hidden');
        };

        window.closeReeseCompose = () => {
            document.getElementById('reese-compose-modal').classList.remove('open');
            document.getElementById('reese-text-input').value = '';
            document.getElementById('reese-text-input').style.height = 'auto';
            reeseImages = []; renderReeseMediaPreview();
        };

        window.handleReeseImageSelect = async (input) => {
            if (input.files) {
                if (input.files.length + reeseImages.length > 2) {
                    saAlert("يمكنك اختيار صورتين فقط كحد أقصى", "error");
                    return;
                }
                for (let i = 0; i < input.files.length; i++) {
                    const base64 = await getBase64(input.files[i]);
                    reeseImages.push(base64);
                }
                renderReeseMediaPreview();
                input.value = '';
            }
        };

        function renderReeseMediaPreview() {
            const div = document.getElementById('reese-media-preview');
            div.innerHTML = '';
            if (reeseImages.length > 0) div.classList.remove('hidden'); else div.classList.add('hidden');
            reeseImages.forEach((img, idx) => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `<img src="${img}"><div class="remove-preview" onclick="removeReeseImage(${idx})"><i class="fas fa-times"></i></div>`;
                div.appendChild(item);
            });
        }

        window.removeReeseImage = (idx) => { reeseImages.splice(idx, 1); renderReeseMediaPreview(); };

        window.publishReese = async () => {
            const text = document.getElementById('reese-text-input').value.trim();
            if(!text && reeseImages.length === 0) return saAlert("اكتب شيئاً أو أضف صورة", "error");
            const postData = { author: currentUser, role: selectedRole, icon: localStorage.getItem('sa_icon'), content: text, images: reeseImages, timestamp: Date.now(), likes: 0 };
            await push(ref(db, 'posts'), postData);
            closeReeseCompose(); saAlert("تم النشر بنجاح!", "success");
        };

        window.loadReesePosts = (prefix) => {
            const container = document.getElementById(`reese-feed-container-${prefix}`);
            container.innerHTML = getMultipleSkeletons(3);
            onValue(ref(db, 'posts'), (snap) => {
                container.innerHTML = '';
                const data = snap.val();
                if(!data) return container.innerHTML = getEmptyStateHTML('posts');
                const hiddenPosts = JSON.parse(localStorage.getItem(`hidden_posts_${currentUser}`) || '[]');
                const posts = Object.entries(data).map(([k,v]) => ({id:k, ...v})).sort((a,b) => b.timestamp - a.timestamp);
                let visibleCount = 0;
                posts.forEach(post => {
                    if(hiddenPosts.includes(post.id)) return;
                    if(isMyPostsView && post.author !== currentUser) return;
                    visibleCount++;
                    const date = new Date(post.timestamp).toLocaleDateString();
                    const roleColor = post.role === 'teacher' ? 'var(--accent-gold)' : 'var(--accent-primary)';
                    const isAuthor = post.author === currentUser;
                    const likedPosts = JSON.parse(localStorage.getItem(`liked_posts_${currentUser}`) || '[]');
                    const isLiked = likedPosts.includes(post.id);
                    let imagesHtml = '';
                    if(post.images && post.images.length > 0) {
                        const gridClass = post.images.length === 1 ? 'one-img' : 'two-imgs';
                        imagesHtml = `<div class="reese-images-grid ${gridClass}">${post.images.map(img => `<img src="${img}" class="reese-post-img" onclick="openImageViewer(this.src)">`).join('')}</div>`;
                    }
                    const div = document.createElement('div');
                    div.className = 'reese-card';
                    div.id = `post-${post.id}`;
                    div.innerHTML = `
                        <div class="reese-header">
                            <div class="reese-user">
                                <div class="avatar-frame" style="width:40px; height:40px; font-size:1.2rem; border-width:1px; margin:0; border-color:${roleColor}; color:${roleColor};">
                                    <i class="fas ${post.icon}"></i>
                                </div>
                                <div><div style="font-weight:bold; font-size:0.95rem;">${post.author}</div><div style="font-size:0.7rem; color:#666;">${date}</div></div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                ${isAuthor ? `<button onclick="deleteReese('${post.id}')" title="حذف نهائي" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1rem;"><i class="fas fa-trash-alt"></i></button>` : ''}
                                <button onclick="hideReese('${post.id}')" title="إخفاء من هنا" style="background:none; border:none; color:#666; cursor:pointer; font-size:1rem;"><i class="fas fa-eye-slash"></i></button>
                            </div>
                        </div>
                        <div class="reese-content">${post.content}</div>${imagesHtml}
                        <div class="reese-actions">
                            <button class="reese-btn ${isLiked ? 'liked' : ''}" onclick="likeReese('${post.id}', ${post.likes || 0})"><i class="fas ${isLiked ? 'fa-thumbs-up' : 'fa-thumbs-up'}"></i> <span>${post.likes || 0}</span></button>
                            <button class="reese-btn" onclick="shareReese('${post.id}')"><i class="fas fa-share"></i> مشاركة</button>
                        </div>`;
                    container.appendChild(div); container.appendChild(createAdBanner());
                });
                if(visibleCount === 0) container.innerHTML = getEmptyStateHTML('posts');
            });
        };

        window.toggleMyPostsView = () => {
            isMyPostsView = !isMyPostsView;
            const prefix = selectedRole === 'teacher' ? 't' : 's';
            const icon = document.getElementById(`${prefix}-eraser-icon`);
            if(isMyPostsView) { icon.style.color = 'var(--danger)'; } else { icon.style.color = '#aaa'; }
            loadReesePosts(prefix);
            saAlert(isMyPostsView ? "عرض منشوراتك فقط (وضع الإدارة)" : "عرض كل المنشورات", "info");
        };

        window.likeReese = async (id, currentLikes) => {
            const likedPosts = JSON.parse(localStorage.getItem(`liked_posts_${currentUser}`) || '[]');
            const index = likedPosts.indexOf(id);
            let newLikes = currentLikes;
            if(index === -1) { likedPosts.push(id); newLikes++; } else { likedPosts.splice(index, 1); newLikes--; }
            localStorage.setItem(`liked_posts_${currentUser}`, JSON.stringify(likedPosts));
            await update(ref(db, `posts/${id}`), { likes: newLikes });
        };

        window.hideReese = (id) => {
            saConfirm("إخفاء هذا المنشور من صفحتك؟", () => {
                const hiddenPosts = JSON.parse(localStorage.getItem(`hidden_posts_${currentUser}`) || '[]');
                hiddenPosts.push(id);
                localStorage.setItem(`hidden_posts_${currentUser}`, JSON.stringify(hiddenPosts));
                loadReesePosts(selectedRole === 'teacher' ? 't' : 's');
            });
        };

        window.deleteReese = (id) => {
            saConfirm("حذف هذا المنشور نهائياً؟ لا يمكن التراجع.", async () => {
                await remove(ref(db, `posts/${id}`)); saAlert("تم الحذف", "success");
            });
        };

        window.openImageViewer = (src) => {
            const modal = document.createElement('div');
            modal.style = "position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; cursor:pointer;";
            modal.innerHTML = `<img src="${src}" style="max-width:95%; max-height:95%; border-radius:10px;">`;
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        };

        window.shareReese = (id) => {
            const url = `${window.location.href.split('?')[0]}?postId=${id}`;
            if(navigator.share) { navigator.share({ title: 'Reese SA', text: 'شاهد هذا المنشور', url: url }).catch(e=>console.log(e)); } 
            else { navigator.clipboard.writeText(url).then(() => saAlert("تم نسخ رابط المنشور", "success")); }
        };

        window.generateAiReese = async () => {
            toggleConstructionOverlay(true, "SA AI THINKING", "توليد أفكار إبداعية...");
            const prompt = `Generate 3 distinct, engaging, and short social media post ideas for a ${selectedRole} on an educational app. Return them as a JSON array of strings (e.g., ["Idea 1", "Idea 2", "Idea 3"]). Language: Arabic. Keep them under 150 characters.`;
            
            try {
                let text = await callPollinationsAI(prompt);
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                let suggestions = [];
                try {
                    suggestions = JSON.parse(text);
                } catch(e) {
                    suggestions = [text];
                }

                if (!Array.isArray(suggestions)) suggestions = [text];

                const container = document.getElementById('ai-reese-suggestions');
                container.innerHTML = '';
                container.classList.remove('hidden');

                suggestions.forEach(sug => {
                    const chip = document.createElement('div');
                    chip.className = 'suggestion-chip';
                    chip.innerHTML = `${sug} <i class="fas fa-plus-circle"></i>`;
                    chip.onclick = () => {
                        document.getElementById('reese-text-input').value = sug;
                    };
                    container.appendChild(chip);
                });
                toggleConstructionOverlay(false);
            } catch(e) { 
                console.error(e);
                toggleConstructionOverlay(false);
                saAlert("فشل التوليد، تأكد من الاتصال.", "error"); 
            }
        };

        function generateChatId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

        window.startNewChat = (prefix) => {
            currentChatId = generateChatId(); currentChatMessages = []; isIncognito = false;
            document.getElementById(`${prefix}-ai-msgs`).innerHTML = ''; 
            document.getElementById(`${prefix}-incognito-btn`).classList.remove('active');
            renderAiWelcome(prefix); toggleHistory(false);
        };

        window.renderAiWelcome = (prefix) => {
            const msgs = document.getElementById(`${prefix}-ai-msgs`);
            const firstName = currentUser.split(' ')[0];
            msgs.innerHTML = `
                <div class="ai-welcome-screen">
                    <div class="ai-logo-large"><i class="fas fa-wand-magic-sparkles"></i></div>
                    <h3 class="ai-welcome-title">مرحباً ${firstName} 👋</h3>
                    <p class="ai-welcome-text">أنا مساعدك الذكي SA AI. <br>يمكنني قراءة الصور، إنشاء الاختبارات، ونشر الأفكار!</p>
                    <div class="ai-chips">
                        <div class="ai-chip" onclick="fillAiInput('${prefix}', 'أنشئ اختبار عن الكيمياء العضوية')"><i class="fas fa-flask"></i> إنشاء اختبار</div>
                        <div class="ai-chip" onclick="fillAiInput('${prefix}', 'انشر بوست عن أهمية التعليم')"><i class="fas fa-feather"></i> كتابة منشور</div>
                        <div class="ai-chip" onclick="fillAiInput('${prefix}', 'اشرح لي هذا المفهوم المعقد ببساطة')"><i class="fas fa-lightbulb"></i> شرح مفهوم</div>
                    </div>
                </div>`;
        };

        window.fillAiInput = (prefix, text) => { document.getElementById(`${prefix}-ai-input`).value = text; };

        window.toggleIncognito = (prefix) => {
            isIncognito = !isIncognito;
            document.getElementById(`${prefix}-incognito-btn`).classList.toggle('active', isIncognito);
            if(isIncognito) saAlert("الوضع المخفي: لن يتم حفظ هذه المحادثة في السجل", "info");
            else saAlert("تم إيقاف الوضع المخفي", "info");
        };

        function saveChatToLocal() {
            if(isIncognito || currentChatMessages.length === 0) return;
            const storageKey = `sa_chat_history_${currentUser}`;
            let history = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const existingIndex = history.findIndex(c => c.id === currentChatId);
            const firstUserMsg = currentChatMessages.find(m => m.role === 'user');
            const title = firstUserMsg ? (firstUserMsg.content.substring(0, 30) + '...') : 'محادثة جديدة';
            const chatObj = { id: currentChatId, title: title, timestamp: Date.now(), messages: currentChatMessages };
            
            if(existingIndex > -1) { 
                history[existingIndex] = chatObj; 
            } else { 
                history.unshift(chatObj); 
            }
            
            localStorage.setItem(storageKey, JSON.stringify(history));
        }

        window.toggleHistory = (show) => {
            const sidebar = document.getElementById('ai-history-sidebar');
            if(show) { 
                renderHistoryList(); 
                sidebar.classList.add('open'); 
            } else { 
                sidebar.classList.remove('open'); 
            }
        };

        function renderHistoryList() {
            const list = document.getElementById('ai-history-list');
            const history = JSON.parse(localStorage.getItem(`sa_chat_history_${currentUser}`) || '[]');
            list.innerHTML = '';
            if(history.length === 0) { list.innerHTML = '<p style="color:#666; text-align:center; margin-top:20px;">لا يوجد سجل محادثات</p>'; return; }
            history.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<div onclick="loadLocalChat('${chat.id}')"><div class="history-title">${chat.title}</div><span class="history-date">${new Date(chat.timestamp).toLocaleDateString()}</span></div><i class="fas fa-trash" style="color:#666; font-size:0.8rem; padding:5px;" onclick="deleteLocalChat('${chat.id}')"></i>`;
                list.appendChild(item);
            });
        }

        window.loadLocalChat = (id) => {
            const history = JSON.parse(localStorage.getItem(`sa_chat_history_${currentUser}`) || '[]');
            const chat = history.find(c => c.id === id);
            if(chat) {
                currentChatId = chat.id; currentChatMessages = chat.messages; isIncognito = false;
                const prefix = selectedRole === 'teacher' ? 't' : 's';
                document.getElementById(`${prefix}-ai-msgs`).innerHTML = '';
                currentChatMessages.forEach(msg => { renderMessageUI(prefix, msg.role, msg.content, msg.image); });
                toggleHistory(false);
            }
        };

        window.deleteLocalChat = (id) => {
            event.stopPropagation();
            saConfirm("حذف هذه المحادثة من السجل؟", () => {
                const storageKey = `sa_chat_history_${currentUser}`;
                let history = JSON.parse(localStorage.getItem(storageKey) || '[]');
                history = history.filter(c => c.id !== id);
                localStorage.setItem(storageKey, JSON.stringify(history));
                renderHistoryList();
                if(currentChatId === id) startNewChat(selectedRole === 'teacher' ? 't' : 's');
            });
        };

        window.shareCurrentChat = async () => {
            if(currentChatMessages.length === 0) return saAlert("لا يمكن مشاركة محادثة فارغة", "info");
            saAlert("جاري إنشاء رابط للمشاركة...", "info");
            const shareRef = push(ref(db, 'shared_chats'));
            await set(shareRef, { author: currentUser, timestamp: Date.now(), messages: currentChatMessages });
            const shareLink = `${window.location.href.split('?')[0]}?shareId=${shareRef.key}`;
            navigator.clipboard.writeText(shareLink).then(() => { saAlert("تم نسخ رابط المحادثة! أرسله لمن تريد.", "success"); });
        };

        window.loadSharedChat = async (shareId, prefix) => {
            const msgs = document.getElementById(`${prefix}-ai-msgs`);
            msgs.innerHTML = '<div style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> جاري استرجاع المحادثة المشاركة...</div>';
            const snap = await get(ref(db, `shared_chats/${shareId}`));
            if(snap.exists()) {
                const data = snap.val();
                currentChatMessages = data.messages || []; currentChatId = generateChatId(); isIncognito = false; saveChatToLocal();
                msgs.innerHTML = `<div style="text-align:center; background:#222; padding:5px; margin-bottom:10px; font-size:0.8rem; border-radius:10px; color:#aaa;">تم استرجاع محادثة مشاركة من ${data.author || 'مجهول'}</div>`;
                currentChatMessages.forEach(msg => { renderMessageUI(prefix, msg.role, msg.content, msg.image); });
                window.history.replaceState({}, document.title, window.location.pathname);
            } else { saAlert("رابط المشاركة غير صالح أو منتهي", "error"); startNewChat(prefix); }
        };

        function formatAiResponseText(text) {
            if(!text) return '';
            let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            safeText = safeText.replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>');
            safeText = safeText.replace(/`(.*?)`/g, '<code>$1</code>');
            safeText = safeText.replace(/^\s*-\s+(.*)$/gm, '<li>$1</li>');
            if(safeText.includes('<li>')) {
                safeText = safeText.replace(/((<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>');
            }
            safeText = safeText.replace(/\n/g, '<br>');
            return safeText;
        }

        function renderMessageUI(prefix, role, text, imgB64) {
            const msgs = document.getElementById(`${prefix}-ai-msgs`);
            const div = document.createElement('div'); 
            div.className = `chat-msg ${role}`; 
            
            if (role === 'ai') {
                div.innerHTML = formatAiResponseText(text);
            } else {
                div.innerText = text;
            }

            if(imgB64) { const img = document.createElement('img'); img.src = imgB64.startsWith('data:') ? imgB64 : `data:image/jpeg;base64,${imgB64}`; div.appendChild(img); }
            msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
        }

        function loadTeacherTests() {
            const list = document.getElementById('t-tests-list');
            const resultSelect = document.getElementById('t-result-select');
            list.innerHTML = getMultipleSkeletons(3);
            onValue(ref(db, 'tests'), (snap) => {
                list.innerHTML = ''; resultSelect.innerHTML = '<option>اختر الاختبار للعرض</option>';
                const data = snap.val() || {};
                let count = 0;
                Object.entries(data).forEach(([key, val]) => {
                    if (val.teacher === currentUser) {
                        count++;
                        const opt = document.createElement('option'); opt.value = key; opt.innerText = val.title; resultSelect.appendChild(opt);
                        const hiddenStyle = val.isHidden ? 'opacity:0.6; border:1px dashed #666;' : '';
                        const cardWrapper = document.createElement('div'); cardWrapper.className = 'card-wrapper';
                        cardWrapper.innerHTML = `
                            <div class="mini-card" style="${hiddenStyle}">
                                <div class="card-header">
                                    <div><h3 class="card-title">${val.title}</h3><div class="card-meta"><span>${getGradeLabel(val.grade)}</span> • <span>${val.duration} دقيقة</span></div></div>
                                    <div class="teacher-badge">نشط</div>
                                </div>
                                <div class="icon-actions">
                                    <button class="action-icon edit" onclick="editTest('${key}')" title="تعديل"><i class="fas fa-pen"></i></button>
                                    <button class="action-icon share" onclick="shareTest('${val.title}', '${key}')" title="مشاركة"><i class="fas fa-share-alt"></i></button>
                                    <button class="action-icon gold" onclick="toggleTestVisibility('${key}', ${!val.isHidden})" title="إخفاء/إظهار"><i class="fas fa-eye${val.isHidden ? '' : '-slash'}"></i></button>
                                    <button class="action-icon results-icon" onclick="openResultsTab('${key}')" title="النتائج"><i class="fas fa-chart-bar"></i></button>
                                    <button class="action-icon delete" onclick="deleteTest('${key}')" title="حذف"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>`;
                        list.appendChild(cardWrapper); list.appendChild(createAdBanner());
                    }
                });
                if(count === 0) list.innerHTML = getEmptyStateHTML('exams');
            });
            resultSelect.onchange = (e) => loadTestResults(e.target.value);
        }

        window.openResultsTab = (testId) => { switchTab('t-results'); document.getElementById('t-result-select').value = testId; loadTestResults(testId); };

        let currentQType = 'mcq';

        window.setQType = (type, label) => {
            currentQType = type;
            document.querySelectorAll('.type-radio-label').forEach(l => l.classList.remove('active'));
            label.classList.add('active');
            const mcqSection = document.getElementById('mcq-section-wrapper');
            if (type === 'essay') {
                mcqSection.classList.add('hidden');
            } else {
                mcqSection.classList.remove('hidden');
                if(document.getElementById('mcq-options-container').children.length === 0) renderOptionFields();
            }
        };

        let optionCount = 2; 
        window.renderOptionFields = (preloadOptions = null, correctVal = null) => {
            const container = document.getElementById('mcq-options-container'); container.innerHTML = '';
            if(preloadOptions) { preloadOptions.forEach(opt => { addOptionField(opt === correctVal, opt); }); } 
            else { addOptionField(true); addOptionField(); }
        };

        window.addOptionField = (isCorrect = false, value = '') => {
            const container = document.getElementById('mcq-options-container');
            if(container.children.length >= 6) return saAlert("الحد الأقصى 6 خيارات", "info");
            const div = document.createElement('div'); div.className = 'option-row';
            div.innerHTML = `
                <input type="radio" name="correct_ans_select" class="option-radio" ${isCorrect ? 'checked' : ''}>
                <input type="text" class="smart-input option-input ${isCorrect ? 'correct' : ''}" value="${value}" placeholder="خيار">
                <button onclick="removeOption(this)" class="icon-btn-small" style="color:var(--danger); background:rgba(239,68,68,0.1);"><i class="fas fa-times"></i></button>
            `;
            div.querySelector('input[type="radio"]').addEventListener('change', () => {
                document.querySelectorAll('.option-input').forEach(i => i.classList.remove('correct'));
                div.querySelector('.option-input').classList.add('correct');
            });
            container.appendChild(div);
        };

        window.removeOption = (btn) => { if(document.getElementById('mcq-options-container').children.length <= 2) return saAlert("يجب وجود خيارين على الأقل", "info"); btn.parentElement.remove(); };

        document.getElementById('q-image-input').onchange = async (e) => {
            if(e.target.files[0]) {
                currentImgBase64 = await getBase64(e.target.files[0]);
                document.getElementById('q-img-preview').classList.remove('hidden');
                document.getElementById('q-img-preview').querySelector('img').src = currentImgBase64;
                document.getElementById('q-img-label').innerText = "تم إرفاق صورة";
            }
        };

        window.addQuestionToList = () => {
            const text = document.getElementById('q-text').value; const points = document.getElementById('q-points').value;
            let options = []; let correctVal = null;
            
            if (currentQType === 'mcq') {
                const rows = document.querySelectorAll('.option-row');
                let hasEmpty = false;
                rows.forEach(row => {
                    const val = row.querySelector('.option-input').value.trim();
                    const isChecked = row.querySelector('input[type="radio"]').checked;
                    if(!val) hasEmpty = true; options.push(val); if(isChecked) correctVal = val;
                });
                if(hasEmpty) return saAlert("يرجى ملء جميع الخيارات", "error");
                if(!correctVal) return saAlert("يرجى تحديد الإجابة الصحيحة", "error");
            } else {
                options = null;
                correctVal = 'essay_evaluation'; 
            }

            if(!text && !currentImgBase64) return saAlert("يجب إضافة نص للسؤال أو صورة", "error");
            
            const questionObj = { 
                type: currentQType, 
                text, 
                points, 
                image: currentImgBase64, 
                options: options, 
                correct: correctVal 
            };
            currentQuestions.push(questionObj); renderAddedQuestions(); clearQuestionForm();
        };

        function clearQuestionForm() {
            document.getElementById('q-text').value = ''; document.getElementById('q-points').value = '1';
            currentImgBase64 = null; document.getElementById('q-image-input').value = '';
            document.getElementById('q-img-preview').classList.add('hidden'); document.getElementById('q-img-label').innerText = "إرفاق صورة";
            renderOptionFields();
        }

        function renderAddedQuestions() {
            const list = document.getElementById('added-questions-list'); list.innerHTML = '';
            currentQuestions.forEach((q, idx) => {
                const typeLabel = q.type === 'essay' ? '<span style="color:var(--accent-primary); font-size:0.8rem;">(مقالي)</span>' : '';
                const div = document.createElement('div'); div.className = 'mini-card';
                div.style = "flex-direction:row; justify-content:space-between; align-items:center;";
                div.innerHTML = `
                    <div style="flex:1;"><span style="font-weight:bold;">س${idx + 1}:</span> ${q.text || 'سؤال صورة'} ${typeLabel} ${q.image ? '<i class="fas fa-image" style="color:var(--accent-primary); margin-right:5px;"></i>' : ''}</div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="editQuestion(${idx})" class="icon-btn-small" style="color:var(--accent-primary); background:rgba(59,130,246,0.1);"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteQuestion(${idx})" class="icon-btn-small" style="color:var(--danger); background:rgba(239,68,68,0.1);"><i class="fas fa-trash"></i></button>
                    </div>`;
                list.appendChild(div);
            });
        }

        window.deleteQuestion = (idx) => { saConfirm("حذف السؤال؟", () => { currentQuestions.splice(idx, 1); renderAddedQuestions(); }); };

        window.editQuestion = (idx) => {
            const q = currentQuestions[idx];
            document.getElementById('q-text').value = q.text; document.getElementById('q-points').value = q.points;
            
            const typeLabels = document.querySelectorAll('.type-radio-label');
            if (q.type === 'essay') {
                setQType('essay', typeLabels[1]);
                typeLabels[1].querySelector('input').checked = true;
            } else {
                setQType('mcq', typeLabels[0]);
                typeLabels[0].querySelector('input').checked = true;
                renderOptionFields(q.options, q.correct);
            }

            if(q.image) {
                currentImgBase64 = q.image;
                document.getElementById('q-img-preview').classList.remove('hidden');
                document.getElementById('q-img-preview').querySelector('img').src = currentImgBase64;
                document.getElementById('q-img-label').innerText = "صورة موجودة";
            }
            
            currentQuestions.splice(idx, 1); renderAddedQuestions();
            document.getElementById('q-editor-box').scrollIntoView({behavior: 'smooth'});
        };

        window.resetCreateForm = () => {
            document.getElementById('new-test-name').value = ''; document.getElementById('new-test-grade').value = ''; document.getElementById('new-test-duration').value = '';
            document.getElementById('custom-grade-input').classList.add('hidden');
            document.getElementById('create-page-title').innerText = "اختبار جديد";
            document.getElementById('btn-save-test').innerHTML = '<i class="fas fa-save"></i> نشر الاختبار النهائي';
            currentQuestions = []; renderAddedQuestions(); clearQuestionForm(); isEditingMode = false; editingTestId = null;
        };

        window.editTest = async (testId) => {
            const snap = await get(ref(db, `tests/${testId}`));
            if(!snap.exists()) return saAlert("الاختبار غير موجود", "error");
            const data = snap.val(); isEditingMode = true; editingTestId = testId;
            switchTab('t-create');
            document.getElementById('create-page-title').innerText = "تعديل الاختبار: " + data.title;
            document.getElementById('btn-save-test').innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
            document.getElementById('new-test-name').value = data.title; document.getElementById('new-test-duration').value = data.duration;
            const gradeSelect = document.getElementById('new-test-grade'); const options = Array.from(gradeSelect.options).map(o => o.value);
            if(options.includes(data.grade)) { gradeSelect.value = data.grade; document.getElementById('custom-grade-input').classList.add('hidden'); } 
            else { gradeSelect.value = 'custom'; document.getElementById('custom-grade-input').classList.remove('hidden'); document.getElementById('custom-grade-input').value = data.grade; }
            currentQuestions = data.questions || []; if(!Array.isArray(currentQuestions)) currentQuestions = Object.values(currentQuestions);
            renderAddedQuestions();
        };

        window.saveTest = async () => {
            const title = document.getElementById('new-test-name').value;
            let grade = document.getElementById('new-test-grade').value; if(grade === 'custom') grade = document.getElementById('custom-grade-input').value;
            const duration = document.getElementById('new-test-duration').value;
            if(!title || !grade || !duration || currentQuestions.length === 0) return saAlert("البيانات ناقصة (تأكد من إضافة سؤال واحد على الأقل)", "error");
            const payload = { teacher: currentUser, title, grade, duration, questions: currentQuestions, timestamp: Date.now(), isHidden: false };
            if (isEditingMode && editingTestId) { await update(ref(db, `tests/${editingTestId}`), payload); saAlert("تم تعديل الاختبار بنجاح!", "success"); } 
            else { await push(ref(db, 'tests'), payload); saAlert("تم نشر الاختبار بنجاح!", "success"); }
            resetCreateForm(); switchTab('t-library');
        };

        window.checkCustomGrade = (el) => { document.getElementById('custom-grade-input').classList.toggle('hidden', el.value !== 'custom'); };
        window.toggleTestVisibility = (k, s) => { update(ref(db, `tests/${k}`), { isHidden: s }); saAlert(s ? "تم إخفاء الاختبار عن الطلاب" : "الاختبار الآن مرئي للطلاب", "info"); };
        window.deleteTest = (k) => { saConfirm("هل أنت متأكد من حذف هذا الاختبار؟", () => { remove(ref(db, `tests/${k}`)); remove(ref(db, `results/${k}`)); saAlert("تم الحذف بنجاح", "success"); }); };

        window.shareTest = (title, id) => {
            const url = `${window.location.href.split('?')[0]}?examId=${id}`;
            if(navigator.share) { navigator.share({ title: 'SA EDU Exam', text: `ندعوكم لأداء اختبار "${title}"`, url: url }).catch(err=>console.log(err)); } 
            else { navigator.clipboard.writeText(url).then(() => saAlert("تم نسخ رابط الاختبار المباشر!", "success")); }
        };
        function getGradeLabel(c) { return ({'1p':'1 ابتدائي','3s':'3 ثانوي'})[c] || c; }

        window.loadTestResults = (testId) => {
            if(!testId || testId.includes('اختر')) return;
            const div = document.getElementById('t-results-container'); div.innerHTML = '<div style="text-align:center;"><i class="fas fa-spinner fa-spin"></i></div>';
            get(ref(db, `results/${testId}`)).then(async snap => {
                div.innerHTML = '';
                if(!snap.exists()) return div.innerHTML = '<p style="text-align:center; color:#666;">لا توجد نتائج لهذا الاختبار بعد</p>';
                snap.forEach(c => {
                    const studentName = c.key; const v = c.val(); const color = v.percentage >= 50 ? 'var(--success)' : 'var(--danger)';
                    const el = document.createElement('div'); el.className = 'mini-card';
                    el.style = "flex-direction:row; justify-content:space-between; align-items:center; margin-bottom:10px;";
                    el.innerHTML = `
                        <div><span style="font-weight:bold; display:block;">${studentName}</span><span style="font-size:0.8rem; color:#888;">${new Date(v.timestamp).toLocaleDateString()}</span></div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-weight:bold; color:${color}; font-size:1.1rem;">${v.percentage}%</span>
                            <button class="action-icon view" onclick="viewStudentDetails('${testId}', '${studentName}')"><i class="fas fa-eye"></i></button>
                        </div>`;
                    div.appendChild(el);
                });
            });
        };

        window.viewStudentDetails = async (testId, studentName) => {
            let phone = "غير مسجل"; const userSnap = await get(ref(db, `users/students/${studentName}`));
            if(userSnap.exists() && userSnap.val().phone) phone = userSnap.val().phone;
            const resSnap = await get(ref(db, `results/${testId}/${studentName}`)); const res = resSnap.val();
            document.getElementById('td-name').innerText = studentName; document.getElementById('td-phone').innerText = phone;
            const list = document.getElementById('td-answers-list'); list.innerHTML = '';
            if (res.details && Array.isArray(res.details)) {
                res.details.forEach((d, i) => {
                    const isEssay = d.type === 'essay';
                    let statusColor;
                    if (isEssay) statusColor = 'var(--accent-primary)'; 
                    else statusColor = d.isCorrect ? 'var(--success)' : 'var(--danger)';
                    
                    const essayBadge = isEssay ? '<span style="font-size:0.7rem; background:rgba(255,255,255,0.1); padding:2px 5px; border-radius:4px;">مقالي</span>' : '';

                    list.innerHTML += `
                        <div style="background:#222; padding:10px; border-radius:10px; margin-bottom:10px; border-right:3px solid ${statusColor}">
                            <p style="margin:0 0 5px; font-weight:bold;">س${i+1}: ${d.q} ${essayBadge}</p>
                            ${d.image ? `<img src="${d.image}" style="max-width:100%; height:auto; border-radius:8px; margin-bottom:10px;">` : ''}
                            <div style="font-size:0.9rem; color:#aaa;">إجابة الطالب: <span style="color:#fff; white-space: pre-wrap;">${d.user}</span></div>
                            ${!d.isCorrect && !isEssay ? `<div style="font-size:0.9rem; color:var(--success);">الصحيحة: ${d.correct}</div>` : ''}
                            ${isEssay ? `<div style="font-size:0.9rem; color:var(--accent-primary); margin-top:5px;">الإجابة النموذجية (AI): ${d.correct || 'غير متوفرة'}</div>` : ''}
                        </div>`;
                });
            } else { list.innerHTML = '<p>لا توجد تفاصيل.</p>'; }
            document.getElementById('teacher-detail-modal').classList.remove('hidden');
        };

        function loadStudentExams() {
            const list = document.getElementById('s-exams-list');
            list.innerHTML = getMultipleSkeletons(3);
            onValue(ref(db, 'tests'), async (snap) => {
                list.innerHTML = ''; const tests = snap.val();
                if (!tests) return list.innerHTML = getEmptyStateHTML('exams');
                let foundExam = false;
                const promises = Object.entries(tests).map(async ([key, val]) => {
                    if (val.isHidden === true) return null;
                    const resSnap = await get(ref(db, `results/${key}/${currentUser}`));
                    return { key, val, hasTaken: resSnap.exists(), score: resSnap.exists() ? resSnap.val().percentage : null };
                });
                const results = await Promise.all(promises);
                results.forEach(item => {
                    if(!item) return; foundExam = true; const { key, val, hasTaken, score } = item;
                    const cardWrapper = document.createElement('div'); cardWrapper.className = 'card-wrapper';
                    let buttonsHtml = hasTaken ? 
                        `<button class="action-icon share" onclick="shareTest('${val.title}', '${key}')" title="مشاركة"><i class="fas fa-share-alt"></i></button>
                            <button class="action-icon edit" onclick="checkPhoneAndStart('${key}')" title="إعادة الاختبار"><i class="fas fa-redo"></i></button>
                            <button class="action-icon gold" onclick="reviewTest('${key}')" title="مراجعة"><i class="fas fa-file-alt"></i></button>` :
                        `<button class="action-icon share" onclick="shareTest('${val.title}', '${key}')" title="مشاركة"><i class="fas fa-share-alt"></i></button>
                            <button class="action-icon edit" style="width:100%; border-radius:15px; background:var(--accent-primary); color:white; justify-content:center;" onclick="checkPhoneAndStart('${key}')"><i class="fas fa-rocket"></i> ابدأ الآن</button>`;
                    cardWrapper.innerHTML = `
                        <div class="mini-card">
                            <div class="card-header">
                                <div><h3 class="card-title">${val.title}</h3><div class="card-meta"><span>${val.teacher}</span> • ${val.duration} دقيقة</div></div>
                                ${hasTaken ? `<span style="color:var(--success); font-weight:bold;">${score}%</span>` : ''}
                            </div>
                            <div class="icon-actions">${buttonsHtml}</div>
                        </div>`;
                    list.appendChild(cardWrapper); list.appendChild(createAdBanner());
                });
                if(!foundExam) list.innerHTML = getEmptyStateHTML('exams');
            });
        }

        window.loadStudentGrades = () => {
                const list = document.getElementById('s-grades-list');
                list.innerHTML = getMultipleSkeletons(2);
                get(ref(db, 'tests')).then(async (testSnap) => {
                    list.innerHTML = ''; const tests = testSnap.val() || {}; let foundAny = false;
                    for(const [testId, testData] of Object.entries(tests)) {
                        const resSnap = await get(ref(db, `results/${testId}/${currentUser}`));
                        if(resSnap.exists()) {
                            foundAny = true; const res = resSnap.val();
                            const color = res.percentage >= 90 ? 'var(--accent-gold)' : (res.percentage >= 50 ? 'var(--success)' : 'var(--danger)');
                            const div = document.createElement('div'); div.className = 'mini-card';
                            div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div><h3 style="font-size:1rem; margin:0;">${testData.title}</h3><span style="font-size:0.8rem; color:#888;">${new Date(res.timestamp).toLocaleDateString()}</span></div>
                                <div style="text-align:left;"><div style="font-weight:bold; font-size:1.4rem; color:${color};">${res.percentage}%</div><div style="font-size:0.8rem; color:#aaa;">${res.score} / ${res.total}</div></div>
                            </div>
                            <button onclick="reviewTest('${testId}')" class="modern-btn secondary" style="margin-top:10px; font-size:0.8rem; padding:8px; justify-content: center;"><i class="fas fa-list-alt"></i> مراجعة التفاصيل</button>`;
                            list.appendChild(div);
                        }
                    }
                    if(!foundAny) list.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">لم تقم بأي اختبارات بعد.</p>';
                });
        };

        let tempTestId = null;
        window.checkPhoneAndStart = async (id) => {
            tempTestId = id; const userSnap = await get(ref(db, `users/students/${currentUser}`));
            if(userSnap.exists() && userSnap.val().phone) startTest(id); else document.getElementById('phone-modal').classList.remove('hidden');
        };

        window.savePhoneAndStart = async () => {
            const phone = document.getElementById('student-phone-input').value.trim();
            if(!phone || phone.length < 10) return saAlert("يرجى إدخال رقم صحيح", "error");
            await update(ref(db, `users/students/${currentUser}`), { phone: phone });
            document.getElementById('phone-modal').classList.add('hidden'); startTest(tempTestId);
        };

        let activeTest = null; let timerInt = null; let answers = {};

        window.startTest = async (id) => {
            const snap = await get(ref(db, `tests/${id}`));
            if (!snap.exists()) return saAlert("عذراً، هذا الاختبار لم يعد موجوداً.", "error");
            activeTest = snap.val(); activeTest.id = id;
            if (!activeTest.questions) activeTest.questions = []; else if (!Array.isArray(activeTest.questions)) activeTest.questions = Object.values(activeTest.questions);
            answers = {};
            document.getElementById('s-taking-test').classList.remove('hidden'); document.getElementById('active-test-title').innerText = activeTest.title;
            const div = document.getElementById('test-questions-render'); div.innerHTML = '';
            if (activeTest.questions.length === 0) { div.innerHTML = '<p style="text-align:center;">لا توجد أسئلة في هذا الاختبار.</p>'; } else {
                activeTest.questions.forEach((q, i) => {
                    const isEssay = q.type === 'essay';
                    let inputHtml = '';
                    
                    if (isEssay) {
                        inputHtml = `<textarea class="smart-input" style="min-height:80px; margin-top:10px;" placeholder="اكتب إجابتك هنا..." onchange="saveAns(${i}, this.value)"></textarea>`;
                    } else {
                        if (!q.options) q.options = []; const shuffled = [...q.options].sort(() => Math.random() - 0.5);
                        inputHtml = shuffled.map(o => `<label class="mini-card" style="flex-direction:row; align-items:center; gap:10px; cursor:pointer; margin-bottom:8px; padding:12px;"><input type="radio" name="q${i}" value="${o}" onchange="saveAns(${i}, '${o}')"><span>${o}</span></label>`).join('');
                    }

                    div.innerHTML += `
                        <div style="margin-bottom:25px;">
                            <p style="font-weight:bold; font-size:1.1rem; margin-bottom:10px;">${i+1}. ${q.text}</p>
                            ${q.image ? `<img src="${q.image}" style="max-width:100%; border-radius:10px; margin-bottom:10px;">` : ''}
                            ${inputHtml}
                        </div>`;
                });
            }
            let time = activeTest.duration * 60; clearInterval(timerInt);
            timerInt = setInterval(() => {
                time--; const m = Math.floor(time/60), s = time%60; document.getElementById('test-timer').innerText = `${m}:${s<10?'0'+s:s}`;
                if(time<=0) submitExam();
            }, 1000);
        };

        window.saveAns = (i, v) => answers[i] = v;
        window.closeExam = () => { saConfirm("خروج من الامتحان؟ ستفقد تقدمك.", () => { clearInterval(timerInt); document.getElementById('s-taking-test').classList.add('hidden'); }); };

        window.submitExam = async () => {
            clearInterval(timerInt); let score = 0, total = 0, details = [];
            const questions = activeTest.questions || [];
            questions.forEach((q, i) => {
                const pts = parseInt(q.points) || 1; 
                total += pts; 
                
                let isCorrect = false;
                if (q.type === 'essay') {
                    if (answers[i] && answers[i].trim().length > 2) {
                        isCorrect = true; 
                        score += pts;
                    }
                } else {
                    isCorrect = answers[i] === q.correct;
                    if(isCorrect) score += pts; 
                }
                
                details.push({ 
                    q: q.text, 
                    image: q.image || null, 
                    user: answers[i]||'-', 
                    correct: q.correct, 
                    isCorrect,
                    type: q.type || 'mcq'
                });
            });
            const pct = total === 0 ? 0 : Math.round((score/total)*100);
            await set(ref(db, `results/${activeTest.id}/${currentUser}`), { score, total, percentage: pct, timestamp: Date.now(), details });
            saAlert(`تم التسليم! النتيجة التقريبية: ${pct}%`, "success");
            document.getElementById('s-taking-test').classList.add('hidden'); loadStudentExams(); loadStudentGrades(); 
        };

        window.reviewTest = async (id) => {
            const resSnap = await get(ref(db, `results/${id}/${currentUser}`));
            if(!resSnap.exists()) return saAlert("لم تقم بهذا الاختبار", "info");
            const res = resSnap.val();
            const div = document.getElementById('review-content'); div.innerHTML = `<h1 style="text-align:center; color:var(--accent-primary); margin-bottom:20px;">${res.percentage}%</h1>`;
            if (res.details && Array.isArray(res.details)) {
                res.details.forEach((d, i) => {
                    const isEssay = d.type === 'essay';
                    const borderColor = d.isCorrect ? 'var(--success)' : (isEssay ? 'var(--accent-primary)' : 'var(--danger)');
                    const icon = d.isCorrect ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : (isEssay ? '<i class="fas fa-pen" style="color:var(--accent-primary)"></i>' : '<i class="fas fa-times-circle" style="color:var(--danger)"></i>');
                    
                    div.innerHTML += `
                        <div class="mini-card" style="border-right:4px solid ${borderColor}">
                            <div style="display:flex; justify-content:space-between;"><strong>س${i+1}: ${d.q}</strong>${icon}</div>
                            ${d.image ? `<img src="${d.image}" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;">` : ''}
                            <div style="margin-top:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;"><p style="margin:0; font-size:0.9rem; color:#aaa;">إجابتك:</p><p style="margin:5px 0 0 0; font-weight:bold; color:${d.isCorrect ? 'var(--success)' : '#fff'}">${d.user}</p></div>
                            ${!isEssay && !d.isCorrect ? `<div style="margin-top:5px; background:rgba(16, 185, 129, 0.1); padding:10px; border-radius:8px;"><p style="margin:0; font-size:0.9rem; color:var(--success);">الإجابة الصحيحة:</p><p style="margin:5px 0 0 0; font-weight:bold;">${d.correct}</p></div>` : ''}
                        </div>`;
                });
            } else { div.innerHTML += '<p>لا توجد تفاصيل متاحة للمراجعة.</p>'; }
            document.getElementById('s-review-test').classList.remove('hidden');
        };

        window.toggleAiGenerator = () => { document.getElementById('ai-gen-modal').classList.toggle('open'); };

        window.previewChatImg = async (prefix) => {
            const input = document.getElementById(`${prefix}-ai-file`);
            if(input.files[0]) {
                const b64 = await getBase64(input.files[0]);
                document.getElementById(`${prefix}-chat-preview`).style.display = 'block';
                document.getElementById(`${prefix}-chat-img-tag`).src = b64;
            }
        };

        window.previewAiGenImg = async (input) => {
            if(input.files[0]) {
                const b64 = await getBase64(input.files[0]);
                aiGenImgBase64 = b64;
                document.getElementById('ai-gen-preview').classList.remove('hidden');
                document.getElementById('ai-gen-preview').querySelector('img').src = b64;
            }
        };

        window.clearChatImg = (prefix) => {
            document.getElementById(`${prefix}-ai-file`).value = '';
            document.getElementById(`${prefix}-chat-preview`).style.display = 'none';
        };

        window.sendAiMsg = async (prefix) => {
            const input = document.getElementById(`${prefix}-ai-input`); 
            const fileInput = document.getElementById(`${prefix}-ai-file`);
            const msgs = document.getElementById(`${prefix}-ai-msgs`); 
            let txt = input.value.trim();
            
            if(!txt && !fileInput.files[0]) return;
            
            if (!fileInput.files[0]) {
                if (txt.includes("أنشئ اختبار") || txt.includes("create exam") || txt.includes("امتحان")) {
                    toggleAiGenerator();
                    const topic = txt.replace("أنشئ اختبار", "").replace("عن", "").replace("create exam", "").replace("about", "").trim();
                    if(topic) document.getElementById('ai-gen-text').value = topic;
                    return; 
                }
                if (txt.includes("انشر") || txt.includes("بوست") || txt.includes("post")) {
                    openReeseCompose();
                    const content = txt.replace("انشر", "").replace("بوست", "").replace("post", "").replace("عن", "").trim();
                    if(content) document.getElementById('reese-text-input').value = content;
                    return;
                }
            }

            const welcomeScreen = msgs.querySelector('.ai-welcome-screen'); 
            if(welcomeScreen) welcomeScreen.remove();
            
            let imgB64 = null;
            let ocrText = "";

            if(fileInput.files[0]) {
                const ocrLoadId = 'ocr-loading-' + Date.now();
                const ocrLoader = document.createElement('div');
                ocrLoader.className = 'chat-msg ai';
                ocrLoader.id = ocrLoadId;
                ocrLoader.innerHTML = '<i class="fas fa-eye fa-spin"></i> جاري تحليل الصورة...';
                msgs.appendChild(ocrLoader);
                
                try {
                    imgB64 = await getBase64(fileInput.files[0]);
                    ocrText = await recognizeImageText(imgB64);
                    document.getElementById(ocrLoadId).remove();
                    clearChatImg(prefix);
                } catch (e) {
                    document.getElementById(ocrLoadId).innerHTML = "فشل تحليل الصورة.";
                    console.error(e);
                    return;
                }
            }
            
            currentChatMessages.push({ role: 'user', content: txt, image: imgB64 });
            renderMessageUI(prefix, 'user', txt, imgB64);
            input.value = ''; 
            saveChatToLocal();
            
            const loadId = 'loading-' + Date.now();
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'chat-msg ai'; 
            loaderDiv.id = loadId; 
            loaderDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            msgs.appendChild(loaderDiv); 
            msgs.scrollTop = msgs.scrollHeight;
            
            try {
                let finalPrompt = "Reply in Arabic. ";
                if (ocrText) {
                    finalPrompt += `Context from image: "${ocrText}". `;
                }
                finalPrompt += txt;
                
                const reply = await callPollinationsAI(finalPrompt);
                
                document.getElementById(loadId).remove();
                currentChatMessages.push({ role: 'ai', content: reply, image: null });
                renderMessageUI(prefix, 'ai', reply, null); 
                saveChatToLocal();
            } catch (e) { 
                document.getElementById(loadId).innerText = "حدث خطأ في الاتصال بالذكاء الاصطناعي."; 
                console.error(e);
            }
        };

        window.generateAiQuestions = async () => {
            const topic = document.getElementById('ai-gen-text').value;
            const mcqCount = document.getElementById('ai-mcq-count').value || 0;
            const essayCount = document.getElementById('ai-essay-count').value || 0;
            const total = parseInt(mcqCount) + parseInt(essayCount);
            
            if (!topic && !aiGenImgBase64) return saAlert("أدخل الموضوع أو ارفع صورة", "error");
            if (total === 0) return saAlert("يجب تحديد عدد الأسئلة", "error");

            toggleConstructionOverlay(true);
            toggleAiGenerator(); 
            
            let contextData = topic;
            if (aiGenImgBase64) {
                try {
                    const textFromImage = await recognizeImageText(aiGenImgBase64);
                    contextData += "\nContent from image: " + textFromImage;
                } catch(e) {
                    toggleConstructionOverlay(false);
                    return saAlert("فشل في قراءة الصورة", "error");
                }
            }
            
            const prompt = `Create a strict JSON array of ${total} questions based on: "${contextData}". 
            Language: Arabic. 
            Requirements: Exactly ${mcqCount} MCQ questions and ${essayCount} Essay questions.
            Structure: [{"type":"mcq", "text":"Question?", "options":["A","B"], "correct":"A", "points":1}, {"type":"essay", "text":"Question?", "correct":"Model Answer for Teacher", "points":1}].
            Return ONLY raw JSON.`;
            
            try {
                let jsonStr = await callPollinationsAI(prompt);
                jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const firstBracket = jsonStr.indexOf('[');
                const lastBracket = jsonStr.lastIndexOf(']');
                if(firstBracket !== -1 && lastBracket !== -1) {
                    jsonStr = jsonStr.substring(firstBracket, lastBracket + 1);
                }

                const questions = JSON.parse(jsonStr);
                
                if (Array.isArray(questions)) {
                    questions.forEach(q => {
                        if(!q.type) q.type = (q.options && q.options.length > 1) ? 'mcq' : 'essay';
                    });

                    currentQuestions = [...currentQuestions, ...questions];
                    renderAddedQuestions();
                    
                    toggleConstructionOverlay(false);
                    saAlert(`تم بناء ${questions.length} سؤال بنجاح!`, "success");
                    switchTab('t-create'); 
                } else {
                    throw new Error("Invalid format");
                }
            } catch (e) { 
                console.error(e);
                toggleConstructionOverlay(false);
                saAlert("فشل البناء. حاول مرة أخرى.", "error"); 
            }
        };

        const savedUser = localStorage.getItem('sa_user'); const savedRole = localStorage.getItem('sa_role'); const savedIcon = localStorage.getItem('sa_icon'); const savedUid = localStorage.getItem('sa_uid');
        if (savedUser && savedRole) {
            currentUser = savedUser; selectedRole = savedRole; myUid = savedUid;
            document.getElementById('landing-layer').classList.add('hidden'); // Ensure hidden if logged in
            loginSuccess(currentUser, savedIcon, savedUid);
        } else { 
            // Only remove hidden if NOT logged in, prevents flash
            document.getElementById('landing-layer').classList.remove('hidden'); 
        }

        let deferredPrompt;
        const pwaBanner = document.getElementById('pwa-install-banner');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                pwaBanner.classList.add('visible');
            }, 2000); 
        });

        window.installPWA = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    deferredPrompt = null;
                }
                closePWA();
            }
        };

        window.closePWA = () => {
            pwaBanner.classList.remove('visible');
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }
    </script>
</body>
</html>

